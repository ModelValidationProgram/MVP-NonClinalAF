---
title: "Non-clinal sims final analysis"
author: "KE Lotterhos"
date: "9/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(viridis)
library(gridExtra)
library(tidyr)
```

`setwd("~/Documents/GitHub/MVP-NonClinalAF/src")`

## Read in data

```{r cars}
out.df <- read.table(file = "../summary.txt", header=TRUE)
head(out.df)
tail(out.df)

sims.df <- read.table(file="0b-final_params_20210830.txt", header=TRUE)
head(sims.df)

final.df <- merge(out.df, sims.df, all.x=TRUE)

vars <- t(final.df[1,])
```


```{r}
hist(final.df$final_LA, xlim=c(0,1), breaks=seq(0,1,0.05), main="", xlab="Degree of local adaptation")
```



## Statistical model

AUCPR ~ trait + demog_level + demog_level_sub + arch_level_sub + arch_level +  + final_LA

```{r}

stat_df <- gather(final.df, key=trait, value=cor_TPR, cor_TPR_temp, cor_TPR_sal)
tail(stat_df)

unique(stat_df$demog_level)
unique(stat_df$demog_level_sub)
unique(stat_df$demog_name)
unique(stat_df$arch_level_sub)
unique(stat_df$arch)

## A model with more hierarchy
modelsum <- summary(aov(cor_TPR ~ trait + demog_level + demog_level_sub + arch_level_sub + arch_level + final_LA + trait*demog_level + trait*arch_level_sub, data=stat_df))

modelsum

pervar <- data.frame(variable = rownames(modelsum[[1]]), SS = modelsum[[1]][,2])

pervar$pervar <- pervar$SS/sum(pervar$SS)*100

pervar

## A model with less hierarchy
modelsum <- summary(aov(cor_TPR ~ trait + demog_name + arch  + trait*demog_name + trait*arch + demog_name*arch +  final_LA, data=stat_df))
modelsum

pervar <- data.frame(variable = rownames(modelsum[[1]]), SS = modelsum[[1]][,2])

pervar$pervar <- round(pervar$SS/sum(pervar$SS)*100, 1)

pervar

```

## How does demography contribute to the evolution of phenotypic clines without clines in causal allele frequencies?
```{r}
boxplot(final.df$cor_TPR_temp~final.df$demog_level, ylim=c(0,1))

ggtheme <- theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), panel.border=element_blank(), axis.line = element_line(colour="grey30"), axis.title = element_text(colour="grey20"), axis.text = (element_text(colour="grey30")), legend.title = element_text(colour="grey20"), legend.text = element_text(colour="grey30"))

final.df$demog_level <- factor(final.df$demog_level, levels=c("SS-Clines", "SS-Mtn", "Est-Clines"), ordered=TRUE)

a<- ggplot(final.df, aes(x=as.factor(N_traits), y=cor_TPR_temp, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none")


forb <- final.df[final.df$N_traits==2,]
forb$N_traits <- factor(forb$N_traits)
b<- ggplot(forb, aes(x=N_traits, y=cor_TPR_sal, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("Proportion of causal Env2 \n loci with significant clines") + scale_color_viridis(discrete=TRUE) 


#pdf("PropCausalAllelesSigClines.pdf", width)
grid.arrange(a,b, nrow=1)
```

```{r}

unique(final.df$demog)
unique(final.df$demog_level)
unique(final.df$demog_level_sub)

final.df$demog_level_sub<- factor(final.df$demog_level_sub, levels=c("N-equal_m-constant", "N-cline-N-to-S_m-constant", "N-cline-center-to-edge_m-constant", "N-equal_m_breaks", "N-variable_m-variable"))

g<- ggplot(final.df, aes(x=as.factor(demog_level_sub), y=cor_TPR_temp, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none") + theme( axis.text.x=element_blank())

h <- ggplot(final.df, aes(x=as.factor(demog_level_sub), y=cor_TPR_sal, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Demography sublevel") + ylab("Proportion of causal Env2 \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none") + theme( axis.text.x=element_text(angle=90, size = 10))

grid.arrange(g,h, nrow=7, ncol=1, layout_matrix=matrix(c(1,1,2,2,2,2,2), nrow=7))
```

## How does genetic architecture contribute to the evolution of phenotypic clines without clines in causal allele frequencies?

```{r}

c <- ggplot(final.df, aes(x=as.factor(arch_level), y=cor_TPR_temp, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Genic level") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none")

d<- ggplot(final.df, aes(x=as.factor(arch_level), y=cor_TPR_sal, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Genic level") + ylab("Proportion of causal Env2 \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none")

grid.arrange(a,b,c,d, nrow=2, ncol=2)

unique(final.df$arch)
unique(final.df$arch_level)
unique(final.df$arch_level_sub)
```

# Architecture sub level
```{r}
e <- ggplot(final.df, aes(x=as.factor(arch), y=cor_TPR_temp, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Genic level") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none") + theme( axis.text.x=element_blank())

f <- ggplot(final.df, aes(x=as.factor(arch), y=cor_TPR_sal, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Genic level") + ylab("Proportion of causal Env2 \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none") + theme( axis.text.x=element_text(angle=90, size = 10))

grid.arrange(e,f, nrow=7, ncol=1, layout_matrix=matrix(c(1,1,2,2,2,2,2), nrow=7))

TO DO: seperate out equal_S from un_equal S to show WHAT IT DOES
```

## Under what conditions can we reliably identify the alleles with effects on adaptive phenotypes using genetic-environment associations (latent factor mixed models, uncorrected correlations, and redundancy analysis)? 

## Can redundancy analysis identify mutations with pleiotropic effects?

## Under what conditions can redundancy analysis predict an individualâ€™s optimal environment, without knowledge of the genetic architecture of adaptation?