---
title: "Non-clinal sims analysis"
author: "KE Lotterhos"
date: "9/20/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(viridis)
library(gridExtra)
library(tidyr)
library(dplyr)
#library(tidyverse)
outputs <- "figures_20220428/"
```

`setwd("~/Documents/GitHub/MVP-NonClinalAF")`
`setwd("/work/lotterhos/MVP-NonClinalAF")`
## Read in data

```{r read data}
out.df <- read.table(file = "summary_20220428.txt", header=TRUE)
head(out.df)
tail(out.df)



load("src/0b-final_params-20220428.RData")
sims.df <- final
head(sims.df)

final.df <- merge(sims.df, out.df, all.x=TRUE)
head(final.df)
(vars <- t(final.df[1,]))

ref <- final.df[,c("seed", "level", "num_causal_postfilter")]

### Make sure 10 reps of each simulation
count <- data.frame(notNA=tapply(final.df$K, final.df$level, 
       function(x){sum(!is.na(x))}
       ))
count

### Make sure no NAs in population structure
sum(is.na(final.df$K))


# Check the levels
levels(final.df$demog_level_sub)
levels(final.df$arch_level_sub)

```

Copy graphs

This optional code is for copying figures for one replicate of each of the 225 levels.
```{r, eval=FALSE, echo=FALSE}
#for (i in 1:225){ #unhash to run
#  file <- paste0("cp sim_output_20220201/",final.df$seed[i],"*.pdf graphs_20220201/")
#  system(file)
#}

# Seeds needed for 10x2 demography graph are the first 15 seeds
#for (i in 1:15){ #unhash to run
#  file <- paste0("cp sim_output_20220201/",final.df$seed[i],"*1pop.pdf graphs2_20220201/")
#  system(file)
#}
```



GGtheme for all figures
```{r ggtheme}

ggtheme <- theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), panel.border=element_blank(), axis.line = element_line(colour="grey30"), axis.title = element_text(colour="grey20"), axis.text = (element_text(colour="grey30")), legend.title = element_text(colour="grey20"), legend.text = element_text(colour="grey30"))

```

## Color schemes
`viridis` for SS, SS-Mtn, Estuary
`mako` for demography sub level (m and N)
`magma` for arch_level_sub
`cividis` for arch_level

## Reorder levels
```{r reorder levels}
str(final.df$arch_level)
levels(final.df$arch_level)
final.df$arch_level <- factor(final.df$arch_level, levels=c( "oliogenic", "mod-polygenic", "highly-polygenic"), ordered=TRUE)

levels(final.df$arch_level) <- c("oligogenic", "mod.\npolygenic", "highly\npolygenic")
str(final.df$arch_level) 


levels(final.df$arch_level_sub)

final.df$arch_level_sub <-
  factor(final.df$arch_level_sub,
  levels=c("1-trait", "2-trait-no-pleiotropy-equal-S",
           "2-trait-pleiotropy-equal-S",
           "2-trait-no-pleiotropy-unequal-S",
           "2-trait-pleiotropy-unequal-S"), ordered=TRUE)

levels(final.df$arch_level_sub) <- c("1 trait", "2 traits, no pleiotropy, equal S",
           "2 traits, pleiotropy, equal S",
           "2 traits, no pleiotropy, unequal S",
           "2 traits, pleiotropy, unequal S")


levels(final.df$arch_level_sub) <- c("1 trait", "2 traits\nno pleiotropy\nequal S",
           "2 traits\npleiotropy\nequal S",
           "2 traits\nno pleiotropy\nunequal S",
           "2 traits\npleiotropy\nunequal S")

final.df$demog_level <- factor(final.df$demog_level, levels=c("SS-Clines", "SS-Mtn", "Est-Clines"), ordered=TRUE)

final.df$demog_level_sub<- factor(final.df$demog_level_sub, levels=c("N-equal_m-constant", "N-equal_m_breaks", "N-cline-N-to-S_m-constant", "N-cline-center-to-edge_m-constant",  "N-variable_m-variable"), ordered=TRUE)

final.df$demog_level_sub <- as.factor(final.df$demog_level_sub)

levels(final.df$demog_level_sub)

levels(final.df$demog_level_sub) <- c("N equal\nm constant", "N equal\nm breaks", "N latitude cline\nm constant", "N central cline\nm constant",  "N variable\nm variable") #warning, make sure in same order as previous code
levels(final.df$demog_level_sub)
```

## Plot mean FST
```{r mean FST}

### Check for missing data
sum(is.na(final.df$meanFst))
summary(final.df$meanFst)
sum(is.na(final.df$arch_level_sub))
sum(is.na(final.df$demog_level))

### Table of mean FST for different levels - no evidence of missing data
tapply(final.df$meanFst, list(final.df$demog_level, final.df$demog_level_sub), mean)
tapply(final.df$meanFst, list(final.df$demog_level, final.df$demog_level_sub), length)

tapply(final.df$meanFst, list(final.df$demog_level, final.df$arch_level_sub), mean)
tapply(final.df$meanFst, list(final.df$demog_level, final.df$arch_level_sub), length)

### Distribution of FST as a funciton of architecture
f <- ggplot(final.df) + geom_histogram(aes(x=meanFst, fill=arch_level_sub), binwidth=0.01, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 0.5)) +  facet_grid(demog_level~.) + scale_fill_viridis(option="magma", discrete=TRUE, name="Pleiotropy level") + xlab("Fst") + ylab("Number of simulations")  + theme(legend.position="bottom") +  guides(fill = guide_legend(reverse = TRUE)) + ggtitle("A")
f

pdf(paste0(outputs,"FST_Demog.pdf"), width=8, height=6)
### Distribution of FST as a funciton of demography
  ggplot(final.df) + geom_histogram(aes(x=meanFst, fill=demog_level_sub), binwidth=0.01, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 0.5))  + facet_grid(demog_level~.) + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("Fst") + ylab("Number of simulations")  + theme(legend.position="bottom") 
  dev.off()

ggplot(final.df, aes(x=as.factor(demog_level_sub), y=meanFst, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Demography") + ylab("overall FST") + scale_color_viridis(discrete=TRUE)  + ylim(0,0.5) + scale_fill_viridis(discrete=TRUE, name="Landscape")

a<-tapply(final.df$meanFst,final.df$demog_name, mean)
b<- tapply(final.df$final_LA,final.df$demog_name, mean)
  
cbind(Fst=a,LA=b)
```

## Degree local adaptation

Visualize the degree of local adapation
```{r LA}

summary(final.df$final_LA)

      l1 <- ggplot(final.df) + geom_histogram(aes(x=final_LA, fill=arch_level_sub), binwidth=0.01, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 0.6)) + facet_grid(demog_level~.) + scale_fill_viridis(option="magma", discrete=TRUE, name="Pleiotropy level") + xlab("Amount of local adaptation") + ylab("Number of simulations")  + theme(legend.position="bottom") +
  guides(fill = guide_legend(reverse = TRUE)) + ggtitle("A")
l1

ggplot(final.df) + geom_histogram(aes(x=final_LA, fill=demog_level_sub), binwidth=0.01, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 0.6)) + facet_grid(demog_level~.) + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("Amount of local adaptation") + ylab("Number of simulations")  + theme(legend.position="bottom") +
  guides(fill = guide_legend(reverse = FALSE)) + ggtitle("A")

l2<- ggplot(final.df) +
        geom_point(aes(x=subsamp_corr_phen_temp,
                       y=subsamp_corr_phen_sal,
                       color=final_LA,shape=demog_level)) + 
        ggtheme +
      scale_color_viridis(option="mako", name="Local\nAdaptation", begin=0.2, end=1) + coord_cartesian(xlim = c(0.25,1)) + ylim(0.25,1) + xlab("Cor(temp. phenotype, deme temperature)") + ylab("Cor(Env2 phenotype, deme Env2)") + ggtitle("B") +labs(shape="Landscape")
  l2
   # in this case, the removed points have an NA because the "sal" trait was not adaptive in 450 simulations:
  
  sum(is.na(final.df$subsamp_corr_phen_temp))
  sum(is.na(final.df$subsamp_corr_phen_sal))
  
pdf(paste0(outputs,"AmountLA.pdf"), width=7, height=8)
  grid.arrange(l1,l2, nrow=2)
dev.off()

```

## Number of loci
```{r plot num loci}

# Create a dataframe for plotting
numloc_df <- gather(final.df, key=filter, value=num_loci_causal, num_causal_prefilter, num_causal_postfilter)

numloc_df$filter <- factor(numloc_df$filter, levels = c("num_causal_prefilter", "num_causal_postfilter"), ordered=TRUE)

levels(numloc_df$filter) <- c("Pre MAF filter", "Post filter MAF > 0 .01")
str(numloc_df$filter)


tapply( numloc_df$num_loci_causal, list(numloc_df$filter,numloc_df$arch_level), mean, na.rm=TRUE)

str(numloc_df$arch_level)

# Plot QTN loci
m<- ggplot(numloc_df ) + geom_boxplot(aes(y=num_loci_causal,x = arch_level, fill=filter), color="grey70") + ggtheme + ylim(0,4000) + ylab("Number of causal loci") + xlab("Architecture") + scale_fill_viridis(option="mako", discrete=TRUE)
m

# Check no missing data
sum(is.na(final.df$num_neut_prefilter))
sum(is.na(final.df$num_neut_postfilter))

# Plot neutral loci
n <- ggplot(final.df) + geom_violin(aes(y=num_neut_postfilter, x=demog_level_sub, fill=demog_level), color="grey70") + ggtheme + ylab("Number of neutral loci\nafter sampling and MAF filter") + xlab("Demography") + guides(fill=guide_legend(title="Landscape"))
n

tapply(final.df$num_neut_postfilter, list(final.df$demog_level_sub), median)
tapply(final.df$num_neut_postfilter, list(final.df$demog_level_sub), mean)

pdf(paste0(outputs,"NumLociPrePostfilter.pdf"), width=7, height=8)
  grid.arrange(m, n, nrow=2)
dev.off()
```


## K (Number of populations)
```{r plot K}

# What determines K?
K_mod <- summary(aov(K~arch + demog_level_sub + demog_level + arch*demog_level_sub*demog_level, data=final.df))
K_mod

# Percent of variance (SS) explained by each
pervarK <- round(K_mod[[1]][,2]/sum(K_mod[[1]][,2]),2)
data.frame(name=rownames(K_mod[[1]]),pervarK)
  # mostly determined by demography

summary(final.df$K)

pdf(paste0(outputs,"K_by_demog.pdf"), width=6, height=6)
  ggplot(final.df) + geom_histogram(aes(x=K, fill=demog_level), binwidth=1, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 11)) + facet_grid(demog_level_sub~.) + scale_fill_viridis(option="viridis", discrete=TRUE, name="Demography") + xlab("Number of population clusters (K)") + ylab("Number of simulations")  + theme(legend.position="bottom") +
  guides(fill = guide_legend(reverse = FALSE)) 
dev.off()
```

## Statistical models

#### MODELS FOR DIVERGENCE (FST) AND FOR AMOUNT Local adaptation (LA)
```{r stat model LA and FST}
levels(final.df$arch)
levels(final.df$demog_level)
levels(final.df$demog_level_sub)

## ANOVA for degree LA
LA_mod <- summary(aov(final_LA~arch + demog_level_sub + demog_level + arch*demog_level_sub*demog_level, data=final.df))
LA_mod
## Perent of SS for each explanatory variable
pervarLA <- round(LA_mod[[1]][,2]/sum(LA_mod[[1]][,2]),2)

## ANOVA for FST
FST_mod <- summary(aov(meanFst ~ arch + demog_level_sub + demog_level + arch*demog_level_sub*demog_level, data=final.df))
FST_mod
## Perent of SS for each explanatory variable
pervarFST <- round(FST_mod[[1]][,2]/sum(FST_mod[[1]][,2]),2)

data.frame(name=rownames(FST_mod[[1]]),pervarLA, pervarFST)
```


#### MODELS FOR allele frequency (AF) clines
```{r stat model proportion of AF clines}

# Create a dataframe for analysis with both traits
stat_df <- gather(final.df, key=trait, value=cor_TPR, cor_TPR_temp, cor_TPR_sal)
tail(stat_df)

# Check the levels in the new dataframe
unique(stat_df$demog_level)
unique(stat_df$demog_level_sub)
unique(stat_df$demog_name)
unique(stat_df$arch_level_sub)
unique(stat_df$arch)


## Statistical model with both traits
  stat_df$trait <- factor(stat_df$trait)
  levels(stat_df$trait)
  levels(stat_df$N_traits)
  
  modelsum <- summary(aov(cor_TPR ~ trait + arch + demog + demog_level +  final_LA + arch*trait*demog, data=stat_df))
  modelsum
  
  ### Percent of variation (SS) explained by each explanatory variable
    pervar <- data.frame(variable = rownames(modelsum[[1]]), SS = modelsum[[1]][,2])
    pervar$pervar <- round(pervar$SS/sum(pervar$SS)*100, 1)
    pervar


## Statistical model with only temperature trait
  modelsum <- summary(aov(cor_TPR_temp ~ arch + demog + demog_level + final_LA + arch*demog*demog_level, data=final.df))
  pervar_temp <- data.frame(variable = rownames(modelsum[[1]]), SS = modelsum[[1]][,2])
  pervar_temp$pervar <- round(pervar_temp$SS/sum(pervar_temp$SS)*100, 1)
  pervar_temp

  ## Statistical model with only salinity trait
  modelsum <- summary(aov(cor_TPR_sal ~ arch + demog + demog_level +  final_LA + arch*demog*demog_level, data=final.df))
  pervar_sal <- data.frame(variable = rownames(modelsum[[1]]), SS = modelsum[[1]][,2])
  pervar_sal$pervar <- round(pervar_sal$SS/sum(pervar_sal$SS)*100, 1)
  pervar_sal

data.frame(variable = pervar_temp$variable, temp_AFcors = pervar_temp$pervar, sal_AFcors = pervar_sal$pervar)
```

# How does demography and genetic architecture contribute to the evolution of phenotypic clines without clines in causal allele frequencies?

## Number of loci with correlations - demog
```{r proportion of allele frequency clines}

# Plote temperatue clines as a function of number of traits and landscape
a<- ggplot(final.df, aes(x=as.factor(N_traits), y=cor_TPR_temp, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none") + ylim(0,1) + ggtitle("C")
a

# Plot Env2 clines as a function of landscape (only 2 trait simulations)
forb <- final.df[final.df$N_traits==2,]
forb$N_traits <- factor(forb$N_traits)
b<- ggplot(forb, aes(x=N_traits, y=cor_TPR_sal, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("Proportion of causal Env2 \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + ylim(0,1) + guides(fill=guide_legend(title="Landscape")) + ggtitle("D")
b


### Pleiotropy vs no pleiotropy - only relevant for sims with 2 traits
  subdf_arch <- final.df[final.df$N_traits==2,]
  unique(final.df$SIGMA_K_1)
  unique(subdf_arch$SIGMA_K_2)
  subdf_arch$SIGMA_K_2 <- as.factor(subdf_arch$SIGMA_K_2)
  my_col_arch <- c(viridis(10)[3], viridis(10)[7])
  
  # temp only
  f1 <-   ggplot(subdf_arch, aes(x=arch_level, y=cor_TPR_temp, fill=as.factor(ispleiotropy))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_fill_manual( values=my_col_arch, labels=c("No pleiotropy", "Pleiotropy"), name="2-trait architectures")  + ylim(0,1) #+ theme(legend.title=element_text("2-trait\narchitectures"))
  f1

  # env2 only
  f2 <-   ggplot(subdf_arch, aes(x=arch_level, y=cor_TPR_sal, fill=as.factor(ispleiotropy))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal sal. \n loci with significant clines") + scale_fill_manual( values=my_col_arch, labels=c("No pleiotropy", "Pleiotropy"), name="2-trait architectures")  + ylim(0,1) #+ theme(legend.title=element_text("2-trait\narchitectures"))
  f2

# Combine data together from f1 and f2 for a single plot
# because they both show the same pattern
pleiotropy.df <- gather(subdf_arch, key=trait, value=cor_TPR, cor_TPR_temp, cor_TPR_sal)

fboth <-   ggplot(pleiotropy.df, aes(x=arch_level, y=cor_TPR, fill=as.factor(ispleiotropy))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal \n loci with significant clines") + scale_fill_manual( values=my_col_arch, labels=c("No pleiotropy", "Pleiotropy"), name="2-trait architectures")  + ylim(0,1) + ggtitle("B")
fboth


## Phenotypic clines vs. af clines

### For each trait, I want to plot the (correlation between the trait and environment) vs. (correlation between af and environment)


f3 <- ggplot(final.df) + 
  geom_point(aes(x=subsamp_corr_phen_temp, y=cor_TPR_temp, color=demog_level, shape=arch_level), alpha=0.6, fill="grey") +  geom_point(aes(x=subsamp_corr_phen_sal, y=cor_TPR_sal, color=demog_level, shape=arch_level), alpha=0.6, fill="grey") + 
  ggtheme + ylim(0,1) + xlim(0,1)  +  
  xlab("Correlation(phenotype, deme environment)") + 
  ylab("Proportion of causal \n loci with significant clines") + scale_color_viridis(name="Landscape", discrete=TRUE) + scale_shape_manual(values=c(0,23, 16),name="Genic level") + ggtitle("A")
f3
# 450 missing values expected (simulations without the Env2 trait)

pdf(paste0(outputs,"WhatDrivesNonClines.pdf"), width=6, height=8)
  grid.arrange(f3, fboth,a,b, nrow=3, ncol=2, layout_matrix=matrix(c(1,1,2,2,3,4), nrow=3, byrow=TRUE))
# 450 missing values expected (simulations without the Env2 trait)
dev.off()

```

## Percent of Va explained by clinal loci

Same plots as above, but for the percent of the additive genetic variance (Va). If clinal loci explain a major proportion of Va, then it could be argued that QTN loci that do not have clinal patterns are not as "important" to discover.

```{r plot proportion of VA explained by clinal loci}

# Reorganize data for plotting
pleiotropy.df2 <- gather(subdf_arch, key=trait, value=cor_VA_prop, cor_VA_temp_prop, cor_VA_sal_prop)

fboth2 <-   ggplot(pleiotropy.df2, aes(x=arch_level, y=cor_VA_prop, fill=as.factor(ispleiotropy))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of explainable VA \n explained by loci with significant clines") + scale_fill_manual( values=my_col_arch, labels=c("No pleiotropy", "Pleiotropy"), name="2-trait architectures")  + ylim(0,1) + ggtitle("A")
fboth2

a1<- ggplot(final.df, aes(x=as.factor(N_traits), y=cor_VA_temp_prop, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("Proportion of explainable VA in temp. \n explained by loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none")+ ylim(0,1) + ggtitle("B")
a1

b1<- ggplot(forb, aes(x=N_traits, y=cor_VA_sal_prop, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("Proportion of explainable VA in Env2 \n loci  explained by loci with significant clines") + scale_color_viridis(discrete=TRUE, name="Landscape") + ylim(0,1) + ggtitle("C") + guides(fill=guide_legend(title="Landscape"))
b1


pdf(paste0(outputs,"WhatDrivesNonClines_VA.pdf"), width=8, height=8)
  grid.arrange(fboth2, a1,b1, nrow=2, ncol=2, layout_matrix=matrix(c(1,1,2,3), nrow=2, byrow=TRUE))
dev.off()
```

## Demography sub level
```{r plot prop. clines as a function of demography}

unique(final.df$demog)
unique(final.df$demog_level)
unique(final.df$demog_level_sub)


pleiotropy.df$demog_level_sub <- as.factor(pleiotropy.df$demog_level_sub)
levels(pleiotropy.df$demog_level_sub) <- c("N equal\nm constant", "N equal\nm breaks", "N latitude cline\nm constant", "N central cline\nm constant",  "N variable\nm variable") # make sure in correct order




## Sub demograph - mako color

d1 <- ggplot(pleiotropy.df, aes(x=as.factor(demog_level_sub), y=cor_TPR, fill=as.factor(demog_level_sub))) + geom_boxplot(color="grey") + ggtheme + xlab("Demography") + ylab("Proportion of causal loci\nwith significant clines") + scale_fill_viridis(option="mako",discrete=TRUE) + theme(legend.position = "none") + theme( axis.text.x=element_text(angle=90,vjust=0.5, hjust=1, size = 10)) + ggtitle("A")
d1

## Strength of selection - magma color
my_col_S <- c(magma(10)[5], magma(10)[8])

s1<- ggplot(subdf_arch, aes(x=arch_level, y=cor_TPR_temp, fill=as.factor(SIGMA_K_2))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_fill_manual( values=my_col_S, labels=c(
  expression(paste("Strong selection ", sigma[K]," = 0.5")), 
  expression(paste("Weak selection ", sigma[K]," = 4.0"))
  ), name="2-trait architectures")  + ylim(0,1) + xlab("Genetic architecture") + ggtitle("B")
s1

pdf(paste0(outputs,"WhatDrivesNonClines-subdemog-selection.pdf"), width=6, height=8)
  grid.arrange(d1, s1, nrow=2)
dev.off()
```



Does hanging strength of selection on trait 1 (temp)  affect the number of allee frequency clines that evolve in trait 2 (env2)? Graph suggests no.
```{r selection strength in opposite trait}
 #+ theme(legend.title=element_text("2-trait\narchitectures"))

ggplot(subdf_arch, aes(x=arch_level, y=cor_TPR_sal, fill=as.factor(SIGMA_K_2))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal sal. \n loci with significant clines") + scale_fill_manual( values=my_col_S, labels=c("Strong selection on other trait (sigma_K=0.5)", "Weak selection on other trait (sigma_K=4)"), name="2-trait architectures")  + ylim(0,1) #+ theme(legend.title=element_text("2-trait\narchitectures"))

```


## Distribution of the correlation between structure and deme environment

```{r correlation between structure and deme environment}

sum(is.na(final.df$cor_PC1_temp))

sc1<- ggplot(final.df) + geom_histogram(aes(x=abs(cor_PC1_temp), fill=demog_level_sub), binwidth=0.05, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 1)) + facet_grid(demog_level~., scales = "free_y") + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("|Cor(PC1, deme temp)|") + ylab("Number of simulations")  + theme(legend.position="none") + ggtitle("A")
sc1

sc2<-ggplot(final.df) + geom_histogram(aes(x=abs(cor_PC2_temp), fill=demog_level_sub), binwidth=0.05, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 1)) + facet_grid(demog_level~., scales = "free_y") + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("|Cor(PC2, deme temp)|") + ylab("Number of simulations")  + theme(legend.position="none") + ggtitle("B")
sc2

sc3<-ggplot(final.df) + geom_histogram(aes(x=abs(cor_PC1_sal), fill=demog_level_sub), binwidth=0.05, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 1)) + facet_grid(demog_level~., scales = "free_y") + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography") + xlab("|Cor(PC1, deme sal)|") + ylab("Number of simulations")  + ggtitle("B") + theme(legend.position="bottom")
sc3

sc4<-ggplot(final.df) + geom_histogram(aes(x=abs(cor_PC2_sal), fill=demog_level_sub, position="stack"), binwidth=0.05,  color="grey") + ggtheme + coord_cartesian(xlim = c(0, 1)) + facet_grid(demog_level~., scales = "free_y") + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("|Cor(PC2, deme sal)|") + ylab("Number of simulations")  + theme(legend.position="bottom") + ggtitle("D")
sc4


pdf(paste0(outputs,"StructureEnvCor_facetDemog.pdf"), width=7, height=10)
    grid.arrange(sc1, sc3, nrow=2)
dev.off()

```

## Under what conditions can we reliably identify the alleles with effects on adaptive phenotypes using genetic-environment associations (latent factor mixed models, uncorrected correlations, and redundancy analysis)? 


## Compare methods AUC
```{r}

# Missing data for temp - 2 sims
sum(is.na(final.df$cor_AUCPR_temp_neutSNPs))
sum(is.na(final.df$cor_AUCPR_sal_neutSNPs)) #expected 450 missing
sum(is.na(final.df$LEA3.2_lfmm2_AUCPR_temp_neutSNPs))
sum(is.na(final.df$LEA3.2_lfmm2_AUCPR_sal_neutSNPs)) #expected 450 missing
sum(is.na(final.df$RDA_AUCPR_neutSNPs))
sum(is.na(final.df$RDA_AUCPR_neutSNPs_corr))

# Missing data for sal - 1 case (note missing data is expected when N_traits==1, because salinity not simulated)
sum(is.na(final.df$cor_AUCPR_sal_neutSNPs & final.df$N_traits==2))
sum(is.na(final.df$LEA3.2_lfmm2_AUCPR_sal_neutSNPs& final.df$N_traits==2))


comparemethods.AUC.temp <- gather(final.df, key=method, value=AUCPR, cor_AUCPR_temp_neutSNPs, LEA3.2_lfmm2_AUCPR_temp_neutSNPs, RDA_AUCPR_neutSNPs, RDA_AUCPR_neutSNPs_corr)

comparemethods.AUC.sal <- gather(final.df, key=method, value=AUCPR, cor_AUCPR_sal_neutSNPs, LEA3.2_lfmm2_AUCPR_sal_neutSNPs) #don't want RDA twice

whichcols <- c("method", "AUCPR", "cor_PC1_temp", "cor_PC1_sal","cor_LFMMU1_temp", "cor_LFMMU1_sal", "cor_LFMMU2_temp", "cor_LFMMU2_sal", "demog_level", "demog_level_sub", "arch_level", "arch_level_sub", "K")

comparemethods.AUC <- rbind(comparemethods.AUC.temp[,whichcols], comparemethods.AUC.sal[whichcols])



# Get lower and upper bounds of box in boxplot
#tapply(comparemethods.AUC$AUCPR, as.factor(comparemethods.AUC$methodtype), quantile,p=0.25, na.rm=TRUE)
#tapply(comparemethods.AUC$AUCPR, as.factor(comparemethods.AUC$methodtype), quantile,p=0.75, na.rm=TRUE)
levels(factor(comparemethods.AUC$method))

comparemethods.AUC$methodtype <- factor(comparemethods.AUC$method)

comparemethods.AUC$methodtype <- revalue(comparemethods.AUC$methodtype,
                                         c("cor_AUCPR_sal_neutSNPs"="Cor(p, Env2)", 
                                           "cor_AUCPR_temp_neutSNPs"= "Cor(p, Temp.)",  
                                           "LEA3.2_lfmm2_AUCPR_sal_neutSNPs" = "LFMM - Env2",
                                           "LEA3.2_lfmm2_AUCPR_temp_neutSNPs" = "LFMM - Temp",
                                           "RDA_AUCPR_neutSNPs"  = "RDA"   ,        
                                           "RDA_AUCPR_neutSNPs_corr" = "pRDA (with\nstructure correction)"  ))
  
levels(comparemethods.AUC$methodtype)
table(comparemethods.AUC$methodtype)

# By landscape
g <- ggplot(comparemethods.AUC, aes(x=as.factor(methodtype), y=AUCPR)) + geom_boxplot(color="grey",  fill="cornflowerblue") + ggtheme + xlab("method") + ylab("AUC-PR")   + theme( axis.text.x=element_text(angle=90,vjust=0.5, hjust=1, size = 10)) + scale_color_viridis(name="Landscape", discrete=TRUE) + guides(fill=guide_legend(title="Landscape"))
g


# as a violin plot (the boxplot is better)
#ggplot(comparemethods.AUC, aes(x=as.factor(methodtype), y=AUCPR, fill=demog_level)) + geom_violin(color="grey") + ggtheme + xlab("method") + ylab("AUC-PR")   + theme( axis.text.x=element_text(angle=90,vjust=0.5, hjust=1, size = 10))


# By demography - not a huge difference among methods
#ggplot(comparemethods.AUC, aes(x=as.factor(methodtype), y=AUCPR, fill=demog_level_sub)) + geom_boxplot(color="grey") + ggtheme + xlab("method") + ylab("AUC-PR")   + theme( axis.text.x=element_text(angle=90,vjust=0.5, hjust=1, size = 10))
```



## Compare methods FDR
```{r}

comparemethods.FDR.temp <- gather(final.df, key=method, value=FDR, cor_FDR_neutSNPs_temp, LEA3.2_lfmm2_FDR_neutSNPs_temp, RDA_FDR_neutSNPs, RDA_FDR_neutSNPs_corr)

comparemethods.FDR.sal <- gather(final.df, key=method, value=FDR, cor_FDR_neutSNPs_sal, LEA3.2_lfmm2_FDR_neutSNPs_sal) #don't want RDA twice

whichcols <- c( "seed", "level", "method", "FDR", "cor_PC1_temp", "cor_PC1_sal","cor_LFMMU1_temp", "cor_LFMMU1_sal", "cor_LFMMU2_temp", "cor_LFMMU2_sal")

comparemethods.FDR <- rbind(comparemethods.FDR.temp[,whichcols], comparemethods.FDR.sal[whichcols])
head(comparemethods.FDR[order(comparemethods.FDR$seed),])


comparemethods.FDR <- comparemethods.FDR[order(comparemethods.FDR$seed),]
tail(comparemethods.FDR)

comparemethods.FDR$methodtype <- factor(comparemethods.FDR$method)
levels(comparemethods.FDR$methodtype)

comparemethods.FDR$methodtype <- revalue(comparemethods.FDR$methodtype,
                                         c("cor_FDR_neutSNPs_sal"="Cor(p, Env2)", 
                                           "cor_FDR_neutSNPs_temp"= "Cor(p, Temp.)",  
                                           "LEA3.2_lfmm2_FDR_neutSNPs_sal" = "LFMM - Env2 (with\nstructure correction)",
                                           "LEA3.2_lfmm2_FDR_neutSNPs_temp" = "LFMM - Temp. (with\nstructure correction)",
                                           "RDA_FDR_neutSNPs"  = "RDA"   ,        
                                           "RDA_FDR_neutSNPs_corr" = "pRDA (with\nstructure correction)"  ))

table(comparemethods.FDR$methodtype)  

g2<- ggplot(comparemethods.FDR, aes(x=as.factor(methodtype), y=FDR)) + geom_boxplot(color="grey", fill="cornflowerblue") + ggtheme + xlab("method") + ylab("FDR") + scale_fill_viridis(option="turbo", discrete=TRUE) + theme(legend.position = "none") + theme( axis.text.x=element_text(angle=90,vjust=0.5, hjust=1, size = 10))
g2

pdf(paste0(outputs,"AUC-PR_FDR.pdf"), width=5, height=5)
grid.arrange(g+ theme( axis.text.x = element_blank(), axis.title.x=element_blank()),
             g2, 
             layout_matrix=matrix(c(1,1,2,2,2), nrow=5))
dev.off()
```

```{r}
Fdr1 <- ggplot(comparemethods.FDR[grep("LEA",comparemethods.FDR$method),], aes(x=FDR)) + geom_density(color="grey", fill="blue") + ggtheme + xlab("method") + xlab("FDR") + scale_fill_viridis(option="turbo", discrete=TRUE) + theme(legend.position = "none") + ggtitle("B) LFMM (structure correction)")
Fdr1

Fdr2 <- ggplot(comparemethods.FDR[grep("cor",comparemethods.FDR$method),], aes(x=FDR)) + geom_density(color="grey", fill="blue") + ggtheme + xlab("method") + xlab("FDR") + scale_fill_viridis(option="turbo", discrete=TRUE) + theme(legend.position = "none") + ggtitle("A) Correlation (no structure correction)")
Fdr2

Fdr3 <- ggplot(comparemethods.FDR[grep("RDA_FDR_neutSNPs",comparemethods.FDR$method),], aes(x=FDR)) + geom_density(color="grey", fill="blue") + ggtheme + xlab("method") + xlab("FDR") + scale_fill_viridis(option="turbo", discrete=TRUE) + theme(legend.position = "none") + ggtitle("C) RDA (no structure correction)")
Fdr3

Fdr4 <- ggplot(comparemethods.FDR[grep("RDA_FDR_neutSNPs_corr",comparemethods.FDR$method),], aes(x=FDR)) + geom_density(color="grey", fill="blue") + ggtheme + xlab("method") + xlab("FDR") + scale_fill_viridis(option="turbo", discrete=TRUE) + theme(legend.position = "none") + ggtitle("D) RDA (with structure correction)")
Fdr4


grid.arrange(Fdr2,  Fdr3, Fdr1, Fdr4, nrow=2)


```

# Trying to understand demography effect on lfmm FDR
```{r}

l1 <- ggplot(final.df) + geom_boxplot(aes(y=LEA3.2_lfmm2_FDR_neutSNPs_temp, x=demog_level_sub, fill=demog_level), color="grey") + ggtheme + guides(fill=guide_legend(title="Landscape")) + xlab("Demography") + ylab("FDR for LFMM (temperature model)")  + theme(legend.position="none") + ylim(0,1)
l1

l2 <- ggplot(final.df) + geom_boxplot(aes(y=LEA3.2_lfmm2_FDR_neutSNPs_sal, x=demog_level_sub, fill=demog_level), color="grey") + ggtheme + guides(fill=guide_legend(title="Landscape")) + xlab("Demography") + ylab("FDR for LFMM (Env2 model)")  + theme(legend.position="none") + ylim(0,1)
l2

#ggplot(final.df) + geom_violin(aes(y=LEA3.2_lfmm2_AUCPR_temp_neutSNPs, x=demog_level_sub, fill=demog_level)) + ggtheme + guides(fill=guide_legend(title="Landscape")) + xlab("Demography") + ylab("")

l3 <- ggplot(final.df) + geom_boxplot(aes(y=abs(cor_LFMMU1_temp), x=demog_level_sub, fill=demog_level), color="grey") + ggtheme + guides(fill=guide_legend(title="Landscape")) + xlab("Demography") + ylab("Cor(LFMM U1, Temp)")  + theme(legend.position="none") + ylim(0,1)
l3

l4 <- ggplot(final.df) + geom_boxplot(aes(y=abs(cor_LFMMU2_temp), x=demog_level_sub, fill=demog_level), color="grey") + ggtheme  + xlab("Demography") + ylab("Correlation (LFMM U2, deme temperature)")   + theme(legend.position="none") + theme(legend.position="bottom") + ylim(0,1) + guides(fill=guide_legend(title="Landscape"))
l4

l5 <- ggplot(final.df) + geom_boxplot(aes(y=abs(cor_LFMMU1_sal), x=demog_level_sub, fill=demog_level), color="grey") + ggtheme + guides(fill=guide_legend(title="Landscape")) + xlab("Demography") + ylab("Cor(LFMM U1, Env2)")   + theme(legend.position="none") + ylim(0,1)
l5

l6 <- ggplot(final.df) + geom_boxplot(aes(y=abs(cor_LFMMU2_sal), x=demog_level_sub, fill=demog_level), color="grey") + ggtheme + guides(fill=guide_legend(title="Landscape")) + xlab("Demography") + ylab("Cor(LFMM U2, Env2)") + theme(legend.position="bottom") + ylim(0,1)
l6

pdf(paste0(outputs,"FDR_LFMM.pdf"), width=10, height=8)

grid.arrange(l1,l2, l3, l5, ncol=2)

dev.off()

```


# LFMM - AUCPR vs STRUCTURE

* If undercorrected, then expect low AUC when the correlation between the latent factor and temp env is very low. 

* If overcorrected, then expect low AUC when the correlation between the latent factor and temp env is very high.
```{r}

k1 <- ggplot(final.df) + geom_point(aes(x=abs(cor_LFMMU1_temp),y=LEA3.2_lfmm2_AUCPR_temp_neutSNPs, color=demog_level_sub, shape=demog_level_sub)) + ggtheme + xlab("cor(LFMM U1, Deme Temperature)") + ylab("AUC-PR") + geom_smooth(aes(x=abs(cor_LFMMU1_temp),y=LEA3.2_lfmm2_AUCPR_temp_neutSNPs, color=demog_level_sub, fill=demog_level_sub), alpha=0.2, method="loess", span=1) + ylim(0,1)  +xlim(0,1) 
k1 # was not easy to change the color scheme here + scale_fill_viridis(option="mako", discrete=TRUE)

k2 <- ggplot(final.df) + geom_point(aes(x=abs(cor_LFMMU1_sal),y=LEA3.2_lfmm2_AUCPR_sal_neutSNPs, color=demog_level_sub, shape=demog_level_sub)) + ggtheme + xlab("cor(LFMM U1, Deme Env2)") + ylab("AUC-PR") + geom_smooth(aes(x=abs(cor_LFMMU1_sal),y=LEA3.2_lfmm2_AUCPR_sal_neutSNPs, color=demog_level_sub, fill=demog_level_sub), alpha=0.2, method="loess", span=1) + ylim(0,1) +xlim(0,1) + scale_fill_viridis(option="mako", discrete=TRUE)
k2

pdf(paste0(outputs,"LFMM-AUCPRvsStructure.pdf"), width=5, height=8)

grid.arrange(k1,k2, nrow=2)

dev.off()
```

## RDA checks

```{r}
#will be able to do with new outputs

par(mfrow=c(2,2))
sum(is.na(final.df$RDA_RDAmutpred_cor_tempEffect))
sum(is.na(final.df$RDA_RDAmutpred_cor_salEffect)) #450 expected
hist(final.df$RDA_RDAmutpred_cor_tempEffect, xlim=c(-1,1))
hist(final.df$RDA_RDAmutpred_cor_salEffect, xlim=c(-1,1))

sum(is.na(final.df$RDA_cor_RDA20000temppredict_tempPhen))
sum(is.na(final.df$RDA_cor_RDA20000salpredict_salPhen))

hist(final.df$RDA_cor_RDA20000temppredict_tempPhen, xlim=c(-1,1))
hist(final.df$RDA_cor_RDA20000salpredict_salPhen, xlim=c(-1,1))


final.df$seed[which(final.df$RDA_RDAmutpred_cor_tempEffect < 0)]
final.df$seed[which(final.df$RDA_RDAmutpred_cor_salEffect < 0)]
final.df$seed[which(final.df$RDA_cor_RDA20000temppredict_tempPhen < 0)]
final.df$seed[which(final.df$RDA_cor_RDA20000salppredict_salPhen < 0)]
```

## Can redundancy analysis identify mutations with pleiotropic effects?
```{r}

g1<- ggplot(final.df, aes(x=RDA_RDAmutpred_cor_tempEffect, fill=arch_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="cividis", discrete=TRUE) + theme(legend.position = "none") + ggtitle("A) Temperature mutation effect")
g1 

g2 <- ggplot(final.df, aes(x=RDA_RDAmutpred_cor_salEffect, fill=arch_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on Env2,\nRDA-predicted Env2 effect)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="cividis", discrete=TRUE) + theme(legend.position="bottom") + ggtitle("B) Env2 mutation effect") 
g2

  grid.arrange(g1, g2,
               layout_matrix = matrix(c(1,1,1,2,2,2,2), nrow=7))
```  


Same analysis as above, but with structure correction

```{r}
g1<- ggplot(final.df, aes(x=RDA_RDAmutpred_cor_tempEffect_structcorr, fill=arch_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="cividis", discrete=TRUE) + theme(legend.position = "none") + ggtitle("A) Temperature mutation effect")
g1 

g2 <- ggplot(final.df, aes(x=RDA_RDAmutpred_cor_salEffect_structcorr, fill=arch_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on Env2,\nRDA-predicted Env2 effect)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="cividis", discrete=TRUE) + theme(legend.position="bottom") + ggtitle("B) Env2 mutation effect") 
g2

grid.arrange(g1, g2,
               layout_matrix = matrix(c(1,1,1,2,2,2,2), nrow=7))


```


Combine the two plots into one, since they show the same pattern:
```{r}
forhist <- gather(final.df, key=env, value=Accuracy, RDA_RDAmutpred_cor_tempEffect, RDA_RDAmutpred_cor_salEffect)

g3 <- ggplot(forhist, aes(x=Accuracy, fill=arch_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Accuracy\nCor(evolved effect size,\n predicted effect size from RDA)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="cividis", discrete=TRUE) +  ggtitle("C) Accuracy of RDA prediction \n     (mutation effect size)") 
g3

```

Another way to view the structure correction - boxplot

```{r}
library(plyr)
### Temp 
RDA_mutpredict <- gather(final.df, key=structcorr, value=Accuracy, RDA_RDAmutpred_cor_tempEffect, RDA_RDAmutpred_cor_tempEffect_structcorr)

RDA_mutpredict$demog_level <- factor(RDA_mutpredict$demog_level)
RDA_mutpredict$structcorr <- factor(RDA_mutpredict$structcorr)
RDA_mutpredict$structcorr <- revalue(RDA_mutpredict$structcorr,c( "RDA_RDAmutpred_cor_tempEffect" = "No (RDA)",                                                           "RDA_RDAmutpred_cor_tempEffect_structcorr" = "Yes (pRDA)"))
levels(RDA_mutpredict$structcorr)

n <- ggplot(RDA_mutpredict, aes(y=Accuracy,x=demog_level, fill=structcorr)) + geom_boxplot(color="grey40") + ggtheme + ylim(-1,1) + ylab("Accuracy of RDA prediction\n(worse <<----->> better)") + ggtitle("D) Temp. mutation effect size")  + guides(fill=guide_legend(title="Structure\nCorrection?")) + 
  theme(axis.text.x=element_blank()) + xlab("")
# Cor(Mutation effect on Temp.,\nRDA-predicted Temp. effect)
n


### Sal
RDA_mutpredict_sal <- gather(final.df, key=structcorr, value=Accuracy, RDA_RDAmutpred_cor_salEffect, RDA_RDAmutpred_cor_salEffect_structcorr)

RDA_mutpredict_sal$demog_level <- factor(RDA_mutpredict_sal$demog_level)
RDA_mutpredict_sal$structcorr <- factor(RDA_mutpredict_sal$structcorr)
RDA_mutpredict_sal$structcorr <- revalue(RDA_mutpredict_sal$structcorr,c( "RDA_RDAmutpred_cor_salEffect" = "No (RDA)",                                                           "RDA_RDAmutpred_cor_salEffect_structcorr" = "Yes (pRDA)"))
levels(RDA_indpredict$structcorr)

o <- ggplot(RDA_mutpredict_sal, aes(y=Accuracy,x=demog_level, fill=structcorr)) + geom_boxplot(color="grey40") + ggtheme + ylim(-1,1) +  ylab("Accuracy of RDA prediction \n(worse <<----->> better)") + ggtitle("E) Env2 mutation effect size")  + guides(fill=guide_legend(title="Structure\nCorrection?"))  + xlab("Landscape")
# "Cor(Mutation effect on Env2,\nRDA-predicted Env2 effect)"
o

pdf(paste0(outputs,"RDA-Predict-Muts.pdf"), width=5, height=7)
  grid.arrange(g3, n,o)
dev.off()
```

What drives the population correction effect?
```{r}

## Temp
## What drives the change in performance with structure correction?
final.df$change_temp_mut <- final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect

summary(aov(final.df$change_temp_mut~final.df$cor_PC1_temp + final.df$cor_PC2_temp + 
              final.df$demog_level + final.df$demog_level_sub + final.df$arch_level))

p1 <- ggplot(final.df) + 
  geom_point(aes(x=abs(cor_PC1_temp), y=change_temp_mut, color=demog_level, shape=demog_level_sub), alpha=0.5) + ggtheme + 
  ylab("Change in accuracy\nafter structure correction\n(worse <<------->> better)") + xlab("|Cor(Structure as PC1, Temp)|") + 
  guides(color=guide_legend(title="Landscape"), shape=guide_legend("Demography")) + ggtitle("A) Mutation effect on Temperature") + ylim(-1,1) + 
  geom_smooth(aes(x=abs(cor_PC1_temp),y=change_temp_mut, color=demog_level, fill=demog_level), alpha=0.2, method="loess", span=1)  + scale_fill_discrete(guide="none") + geom_hline(yintercept=0, color="black")
p1


#####################
## Env 2 trait
#####################

## What drives the change in performance with structure correction?
final.df$change_sal_mut <- final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect
summary(aov(final.df$change_sal_mut~final.df$cor_PC1_sal+ final.df$cor_PC2_sal + 
              final.df$demog_level + final.df$demog_level_sub + final.df$arch_level))


p2 <- ggplot(final.df) + geom_point(aes(x=abs(cor_PC1_sal), y=change_sal_mut, color=demog_level, shape=demog_level_sub), alpha=0.5) + ggtheme + ylab("Change in accurcay\nafter structure correction\n(worse <<------->> better)") + xlab("|Cor(Structure as PC1, Env2)|") + guides(color=guide_legend(title="Landscape"), shape=guide_legend("Demography")) + ggtitle("B) Mutation effect on Env2") + ylim(-1,1) + 
  geom_smooth(aes(x=abs(cor_PC1_sal),y=change_sal_mut, color=demog_level, fill=demog_level), alpha=0.2, method="loess", span=1) + scale_fill_discrete(guide="none") + geom_hline(yintercept=0, color="black")
p2


pdf(paste0(outputs,"RDA-Predict-Muts-CovariateStructure.pdf"), width=6, height=7)
  grid.arrange(p1, p2)
dev.off()


```




## Under what conditions can redundancy analysis predict an individualâ€™s optimal environment, without knowledge of the genetic architecture of adaptation?


Visualize the effect of genetic architecture on phenotype prediction
```{r}
forhist <- gather(final.df, key=env, value=Accuracy, RDA_cor_RDA20000temppredict_tempPhen, RDA_cor_RDA20000salpredict_salPhen)

g4 <- ggplot(forhist, aes(x=Accuracy, fill=arch_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Accuracy\nCor(evolved phenotype,\n predicted phenotype from RDA)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="cividis", discrete=TRUE) +  ggtitle("B) Accuracy of RDA prediction \n     (individual environmental phenotype)") 
g4



```


Accuracy of RDA prediction maxed out by cor (phenotype, Env)

```{r}
#Scatterplot

levels(final.df$demog_level_sub)
  
n1 <- ggplot(final.df[order(final.df$demog_level_sub, decreasing=TRUE),]) +   geom_point(aes(x=subsamp_corr_phen_temp,
                   y=RDA_cor_RDA20000temppredict_tempPhen, color=demog_level,
	                   shape=demog_level_sub), bg="red",alpha=0.3) + ylim(0,1) + xlim(0,1) +
     ggtheme + geom_abline(slope=1, color="grey") + 
  scale_shape_manual(values = c(0, 1, 10, 11, 21), name="Demography") + guides(color=guide_legend(title="Landscape")) +
  xlab("Evolved phenotypic cline\nCor(Temp. phenotype, Deme Temp.)") +
  ylab("Prediction accuracy\nCor(RDA prediction,\nTemp. phenotype)") + ggtitle("C) Accuracy of RDA prediction\n     (Temp. trait)")
  
n1 

n2<-  ggplot(final.df[order(final.df$demog_level_sub, decreasing=TRUE),]) +   geom_point(aes(x=subsamp_corr_phen_sal,
                   y=RDA_cor_RDA20000salpredict_salPhen, color=demog_level,
	                   shape=demog_level_sub), alpha=0.3, bg="red") + ylim(0,1) + xlim(0,1) + 
     ggtheme + geom_abline(slope=1, color="grey") + 
  scale_shape_manual(values = c(0, 1, 10, 11, 21), name="Demography") + guides(color=guide_legend(title="Landscape")) +
  xlab("Evolved phenotypic cline\nCor(Env2 phenotype, Deme Env2)") +
  ylab("Prediction accuracy\nCor(RDA prediction,\nEnv2 phenotype)")  +
  ggtitle("D) Accuracy of RDA prediction\n     (Env2 trait)")
n2  

pdf(paste0(outputs,"RDA-Demog-scatter.pdf"), width=12, height=8)

  grid.arrange(g4,  n1, g4, n2, ncol=2)
dev.off()


#hist(final.df$cor_RDA20000_RDloadings_tempPhen, xlim=c(0,1), breaks=seq(0,1,0.05))
#hist(final.df$cor_RDA20000_RDloadings_salPhen, xlim=c(0,1), breaks=seq(0,1,0.05))
```

# Effect of structure correction

```{r}

RDA_indpredict <- gather(final.df, key=structcorr, value=Accuracy, RDA_cor_RDA20000temppredict_tempPhen, RDA_cor_RDA20000temppredict_tempPhen_structcorr)

RDA_indpredict$demog_level <- factor(RDA_indpredict$demog_level)
RDA_indpredict$structcorr <- factor(RDA_indpredict$structcorr)
RDA_indpredict$structcorr <- revalue(RDA_indpredict$structcorr,c( "RDA_cor_RDA20000temppredict_tempPhen" = "No (RDA)", "RDA_cor_RDA20000temppredict_tempPhen_structcorr" = "Yes (pRDA)"))
levels(RDA_indpredict$structcorr)

n <- ggplot(RDA_indpredict, aes(y=Accuracy,x=demog_level, fill=structcorr)) + geom_boxplot(color="grey40") + ggtheme + ylim(-1,1) + ylab("Accuracy\nCor(evolved Temp. phenotype,\n predicted Temp. phenotype from RDA)") + ggtitle("A) Accuracy of RDA prediction\n      (Temp. phenotype)")  + guides(fill=guide_legend(title="Structure\nCorrection?")) + xlab("Landscape")
n


## Same as above for Env2 trait
RDA_indpredict_sal <- gather(final.df, key=structcorr, value=Accuracy, RDA_cor_RDA20000salpredict_salPhen, RDA_cor_RDA20000salpredict_salPhen_structcorr)

RDA_indpredict_sal$demog_level <- factor(RDA_indpredict_sal$demog_level)
RDA_indpredict_sal$structcorr <- factor(RDA_indpredict_sal$structcorr)
RDA_indpredict_sal$structcorr <- revalue(RDA_indpredict_sal$structcorr,c( "RDA_cor_RDA20000salpredict_salPhen" = "No (RDA)", "RDA_cor_RDA20000salpredict_salPhen_structcorr" = "Yes (pRDA)"))
levels(RDA_indpredict_sal$structcorr)

o <- ggplot(RDA_indpredict_sal, aes(y=Accuracy,x=demog_level, fill=structcorr)) + geom_boxplot(color="grey40") + ggtheme + ylim(-1,1) + ylab("Accuracy\nCor(evolved Env2. phenotype,\n predicted Env2. phenotype from RDA)") + ggtitle("B) Accuracy of RDA prediction\n      (Env2. phenotype)")  + guides(fill=guide_legend(title="Structure\nCorrection?")) + xlab("Landscape")
o


pdf(paste0(outputs,"RDA-Predict-Phen-struct.pdf"), width=5, height=7)
  grid.arrange(n, o)
dev.off()
```

Understand how correlation with PC affects structure correction
```{r}


## Temp
## What drives the change in performance with structure correction?
final.df$change_temp <- final.df$RDA_cor_RDA20000temppredict_tempPhen_structcorr - final.df$RDA_cor_RDA20000temppredict_tempPhen

summary(aov(final.df$change_temp~final.df$cor_PC1_temp + final.df$cor_PC2_temp + 
              final.df$demog_level + final.df$demog_level_sub + final.df$arch_level))

p1 <- ggplot(final.df) + 
  geom_point(aes(x=abs(cor_PC1_temp), y=change_temp, color=demog_level, shape=demog_level_sub), alpha=0.5) + ggtheme + 
  ylab("Change in accuracy\nafter structure correction\n(worse <<------->> better)") + xlab("|Cor(Structure as PC1, Temp)|") + 
  guides(color=guide_legend(title="Landscape"), shape=guide_legend("Demography")) + ggtitle("A) Temperature Phenotype") + ylim(-1,1) + 
  geom_smooth(aes(x=abs(cor_PC1_temp),y=change_temp, color=demog_level, fill=demog_level), alpha=0.2, method="loess", span=1)  + scale_fill_discrete(guide="none")
p1

#####################
## Env 2 trait
#####################

## What drives the change in performance with structure correction?
final.df$change_sal <- final.df$RDA_cor_RDA20000salpredict_salPhen_structcorr - final.df$RDA_cor_RDA20000salpredict_salPhen
summary(aov(final.df$change_sal~final.df$cor_PC1_sal+ final.df$cor_PC2_sal + 
              final.df$demog_level + final.df$demog_level_sub + final.df$arch_level))


p2 <- ggplot(final.df) + geom_point(aes(x=abs(cor_PC1_sal), y=change_sal, color=demog_level, shape=demog_level_sub), alpha=0.5) + ggtheme + ylab("Change in accuracy\nafter structure correction\n(worse <<------->> better)") + xlab("|Cor(Structure as PC1, Env2)|") + guides(color=guide_legend(title="Landscape"), shape=guide_legend("Demography")) + ggtitle("B) Env2 Phenotype") + ylim(-1,1) + 
  geom_smooth(aes(x=abs(cor_PC1_sal),y=change_sal, color=demog_level, fill=demog_level), alpha=0.2, method="loess", span=1) + scale_fill_discrete(guide="none")
p2

pdf(paste0(outputs,"RDA-Predict-Traits-CovariateStructure.pdf"), width=6, height=7)
  grid.arrange(p1, p2)
dev.off()
#hist(final.df$cor_RDA20000_RDloadings_tempPhen, xlim=c(0,1), breaks=seq(0,1,0.05))
#hist(final.df$cor_RDA20000_RDloadings_salPhen, xlim=c(0,1), breaks=seq(0,1,0.05))
```

Well, this is interesting. The accuracy of the mutation loadings on the RDA axis is much lower for the highly polygenic architectures. Which makes sense.

The ironic thing is that the phenotypic prediction from the RDA is still accurate, and it is affected more by the degree that the phenotype is correlated with the environment.

### Statistical models
```{r}
# STat models

summary(aov(RDA_cor_RDA20000temppredict_tempPhen~ subsamp_corr_phen_temp + demog_level + demog_level_sub + arch_level, data=final.df))
summary(aov(RDA_cor_RDA20000salpredict_salPhen~ subsamp_corr_phen_sal + demog_level + demog_level_sub + arch_level, data=final.df))


summary(aov(RDA_RDAmutpred_cor_tempEffect~ subsamp_corr_phen_temp + demog_level + demog_level_sub + arch_level, data=final.df))
summary(aov(RDA_RDAmutpred_cor_salEffect~ subsamp_corr_phen_temp + demog_level + demog_level_sub + arch_level, data=final.df))

# a paradox - architecture determines the proportion of clines - architecture also largely determines how accurate the mutation prediction is - yet the RDA phenotype prediction is not sensitive to the architecture and it is driven more by how correlated the phenotype is with the environment!

```


## Interesting sims to look at

```{r}
summary(final.df$RDA_RDAmutpred_cor_tempEffect)
summary(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr)
summary(final.df$RDA_RDAmutpred_cor_salEffect)
summary(final.df$RDA_RDAmutpred_cor_salEffect_structcorr)

# What is the difference between with and without structure?
par(mfrow=c(1,1))
hist(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect, xlim=c(-1,1))

hist(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect, xlim=c(-1,1))

# The seed with the most improvement from structcorr for temp
  i1 <- which(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect == max(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect))
  
  paste(final.df$level[i1], final.df$seed[i1])

# The seed with the least improvement from structcorr for temp
  i2 <- which(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect == min(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect))
  
  paste(final.df$level[i2],final.df$seed[i2])
  
# The seed with the most improvement from structcorr for sal
  i3 <- which(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect == max(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect, na.rm=TRUE))
  
  paste(final.df$level[i3],final.df$seed[i3])
  
# The seed with the least improvement from structcorr for sal
    i4 <- which(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect == min(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect, na.rm=TRUE))
  
    paste(final.df$level[i4],final.df$seed[i4])

# Seeds from Estuary sim, mod poly with high performance
  levels(final.df$demog_level)
   levels(final.df$arch_level)
   unique(final.df$ispleiotropy)
   unique(final.df$arch_level_sub)

  i5 <- final.df %>% 
    filter(demog_level=="Est-Clines", arch_level== "mod.\npolygenic", ispleiotropy==1, arch_level_sub== "2 traits\npleiotropy\nequal S") %>% 
    arrange(desc(RDA_cor_RDA20000temppredict_tempPhen), desc(RDA_cor_RDA20000salpredict_salPhen)) %>%
    head(4) %>% 
    select(level,seed,RDA_RDAmutpred_cor_salEffect, RDA_RDAmutpred_cor_tempEffect,
           RDA_cor_RDA20000salpredict_salPhen, RDA_cor_RDA20000temppredict_tempPhen)
  i5  

  # Seeds from mod poly with LOW performance
  i6 <- final.df %>% 
    filter(arch_level== "mod.\npolygenic",) %>% 
    arrange((RDA_cor_RDA20000temppredict_tempPhen), (RDA_cor_RDA20000salpredict_salPhen)) %>%
    head(2) %>% 
    select(level,seed,RDA_RDAmutpred_cor_salEffect, RDA_RDAmutpred_cor_tempEffect,
           RDA_cor_RDA20000salpredict_salPhen, RDA_cor_RDA20000temppredict_tempPhen)
  
  i6
  
  # Seed for improvement in Env2 trait prediction but worse temp trait prediction after structure correction
  
  i7 <- final.df %>% 
    filter(arch_level== "mod.\npolygenic",) %>% 
    arrange(desc(RDA_cor_RDA20000salpredict_salPhen_structcorr-RDA_cor_RDA20000salpredict_salPhen),(RDA_cor_RDA20000temppredict_tempPhen_structcorr-RDA_cor_RDA20000temppredict_tempPhen) ) %>%
    head(2) %>% 
    select(level,seed,RDA_RDAmutpred_cor_salEffect, RDA_RDAmutpred_cor_tempEffect,
           RDA_cor_RDA20000salpredict_salPhen, RDA_cor_RDA20000salpredict_salPhen_structcorr, 
           RDA_cor_RDA20000temppredict_tempPhen, RDA_cor_RDA20000temppredict_tempPhen_structcorr)
  i7
  
  (All_example_seeds <- sort(c(final.df$seed[i1], final.df$seed[i2], final.df$seed[i3],
                         final.df$seed[i4], i5$seed, i6$seed, i7$seed)))
  
  
```





















Do other factors affect the correlation between mutation loading and mutation effect on phenotype?
```{r}
TO DO: Dig into mutation effect some more and make sure Im not missing anything
FIX COLORS IN THESE PLOTS

ggplot(final.df, aes(x=RDA_RDAmutpred_cor_tempEffect, fill=demog_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Landscape")) 

ggplot(final.df, aes(x=RDA_RDAmutpred_cor_tempEffect, fill=demog_level_sub)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Landscape"))

ggplot(final.df, aes(x=RDA_RDAmutpred_cor_tempEffect, fill=arch_level_sub)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Pleiotropy\nArchitecture")) 


ggplot(final.df, aes(x=RDA_RDAmutpred_cor_salEffect, fill=demog_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Landscape")) 

ggplot(final.df, aes(x=RDA_RDAmutpred_cor_salEffect, fill=demog_level_sub)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Landscape"))

ggplot(final.df, aes(x=RDA_RDAmutpred_cor_salEffect, fill=arch_level_sub)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(mutation effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Pleiotropy\nArchitecture")) 


```

#correlation between position on landscape and environment
final.df$pos_env_corr <- final.df$demog_level

final.df$level[1]
popEst <- read.table(paste0("sim_output_20220428/",final.df$seed[1], "_popInfo.txt"), header=TRUE)
cor(popEst$opt0, popEst$x) #Env2
cor(popEst$opt1, popEst$y) #temp

final.df$level[11]
popSSMtn <- read.table(paste0("sim_output_20220428/",final.df$seed[11], "_popInfo.txt"), header=TRUE)
cor(popSSMtn$opt0, popSSMtn$x) #Env2
cor(popSSMtn$opt1, popSSMtn$y) #temp





Some additional RDA plots to show the effect of demography
```{r}



n <- ggplot(final.df, aes(x=RDA_cor_RDA20000temppredict_tempPhen, fill=demog_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(temp. phenotype,\nRDA-predicted temp. phenotype)") + guides(fill=guide_legend(title="Landscape")) + ggtitle("A) Temperature phenotype") + theme(legend.position = "none")
n

n2 <- ggplot(final.df, aes(x=RDA_cor_RDA20000temppredict_tempPhen_structcorr, fill=demog_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(temp. phenotype,\nRDA-predicted temp. phenotype)") + guides(fill=guide_legend(title="Landscape")) + ggtitle("A) Temperature phenotype") + theme(legend.position = "none")
n2



o <- ggplot(final.df, aes(x=RDA_cor_RDA20000salpredict_salPhen, fill=demog_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(Env2 phenotype,\nRDA-predicted Env2 phenotype)") + guides(fill=guide_legend(title="Landscape")) + ggtitle("B) Env. 2 phenotype") + theme(legend.position="bottom")
o

o2 <- ggplot(final.df, aes(x=RDA_cor_RDA20000salpredict_salPhen_structcorr, fill=demog_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(Env2 phenotype,\nRDA-predicted Env2 phenotype)") + guides(fill=guide_legend(title="Landscape")) + ggtitle("B) Env. 2 phenotype") + theme(legend.position="bottom")
o2



ggplot(final.df, aes(x=RDA_cor_RDA20000temppredict_tempPhen, fill=arch_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(temp. phenotype,\nRDA-predicted temp. phenotype)") + guides(fill=guide_legend(title="Landscape")) + ggtitle("A) Temperature phenotype") + theme(legend.position = "none") + scale_fill_viridis(option="cividis", discrete=TRUE)

ggplot(final.df, aes(x=RDA_cor_RDA20000salpredict_salPhen, fill=arch_level)) + geom_histogram(color="grey40") + ggtheme + xlim(-1,1) + xlab("Cor(Env2 phenotype,\nRDA-predicted Env2 phenotype)") + guides(fill=guide_legend(title="Landscape")) + ggtitle("B) Env. 2 phenotype") + theme(legend.position="bottom") + scale_fill_viridis(option="cividis", discrete=TRUE)

rda.df <- gather(final.df, key=trait, value=cor_RDApred_phen, RDA_cor_RDA20000temppredict_tempPhen, RDA_cor_RDA20000salpredict_salPhen)

r0 <- ggplot(rda.df, aes(x=cor_RDApred_phen, fill=demog_level)) + geom_histogram(color="grey30") + ggtheme + xlim(0,1) + xlab("Cor( phenotype, RDA predicted phenotype)") + facet_grid(~trait)

r1 <- ggplot(rda.df, aes(x=cor_RDApred_phen, fill=arch_level)) + geom_histogram(color="grey30") + ggtheme + xlim(0,1) + xlab("Cor( phenotype, RDA predicted phenotype)") + facet_grid(~trait)

r2 <- ggplot(rda.df, aes(x=cor_RDApred_phen, fill=as.factor(ispleiotropy))) + geom_histogram(color="grey30") + ggtheme + xlim(0,1) + xlab("Cor(temp. phenotype, RDA predicted temp. phenotype)") + facet_grid(~trait)

r3 <- ggplot(rda.df, aes(x=cor_RDApred_phen, fill=demog_level_sub)) + geom_histogram(color="grey30") + ggtheme + xlim(0,1) + xlab("Cor(temp. phenotype, RDA predicted temp. phenotype)") + facet_grid(~trait)

r4 <- ggplot(rda.df, aes(x=cor_RDApred_phen, fill=as.factor(SIGMA_K_2))) + geom_histogram(color="grey30") + ggtheme + xlim(0,1) + xlab("Cor(temp. phenotype, RDA predicted temp. phenotype)") + facet_grid(~trait)

pdf(paste0(outputs,"RDA_phen_predict_breakdown.pdf"), height=12, width=10)
grid.arrange(r0, r1, r2, r3, r4, nrow=5)
dev.off()

trait.labs <- c("Env2", "Temperature")
names(trait.labs) <- c("Env2", "Temperature")

r4 <- ggplot(final.df, aes(x=cor_RDA20000_RDloadings_tempPhen, fill=as.factor(SIGMA_K_2))) + geom_histogram(color="grey30") + ggtheme + xlim(0,1) + xlab("Cor(temp phenotype,\nRDA-predicted temp phenotype)") +  guides(fill=guide_legend(title="Stabilizing\nSelection"))
r4

pdf(paste0(outputs,"RDA-predict-strengthselection.pdf"), width=4, height=3)
  r4
dev.off()
```


