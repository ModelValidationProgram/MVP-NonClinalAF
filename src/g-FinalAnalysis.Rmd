---
title: "Non-clinal sims analysis"
author: "KE Lotterhos"
date: "9/20/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(viridis)
library(gridExtra)
library(tidyr)
library(dplyr)
library(plyr)
#library(tidyverse)
outputs <- "figures_20220428/"
```

`setwd("~/Documents/GitHub/MVP-NonClinalAF")`
`setwd("/work/lotterhos/MVP-NonClinalAF")`
## Read in data

```{r read data}
out.df <- read.table(file = "summary_20220428.txt", header=TRUE)
head(out.df)
tail(out.df)



load("src/0b-final_params-20220428.RData")
sims.df <- final
head(sims.df)

final.df <- merge(sims.df, out.df, all.x=TRUE)
head(final.df)
(vars <- t(final.df[1,]))

ref <- final.df[,c("seed", "level", "num_causal_postfilter")]

### Make sure 10 reps of each simulation
count <- data.frame(notNA=tapply(final.df$K, final.df$level, 
       function(x){sum(!is.na(x))}
       ))
count

### Make sure no NAs in population structure
sum(is.na(final.df$K))


# Check the levels
levels(final.df$demog_level_sub)
levels(final.df$arch_level_sub)

```

Copy graphs

This optional code is for copying figures for one replicate of each of the 225 levels.
```{r, eval=FALSE, echo=FALSE}
#for (i in 1:225){ #unhash to run
#  file <- paste0("cp sim_output_20220201/",final.df$seed[i],"*.pdf graphs_20220201/")
#  system(file)
#}

# Seeds needed for 10x2 demography graph are the first 15 seeds
#for (i in 1:15){ #unhash to run

#  file <- paste0("cp sim_output_20220201/",final.df$seed[i],"*1pop.pdf graphs2_20220201/")
#  system(file)
#}
```



GGtheme for all figures
```{r ggtheme}

ggtheme <- theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), panel.border=element_blank(), axis.line = element_line(colour="grey30"), axis.title = element_text(colour="grey20"), axis.text = (element_text(colour="grey30")), legend.title = element_text(colour="grey20"), legend.text = element_text(colour="grey30"))

```

## Color schemes
`viridis` for SS, SS-Mtn, Estuary
`mako` for demography sub level (m and N)
`magma` for arch_level_sub
`rocket` for arch_level

## Reorder levels
```{r reorder levels}
str(final.df$arch_level)
levels(final.df$arch_level)
final.df$arch_level <- factor(final.df$arch_level, levels=c( "oliogenic", "mod-polygenic", "highly-polygenic"), ordered=TRUE)

levels(final.df$arch_level) <- c("oligogenic", "mod.\npolygenic", "highly\npolygenic")
str(final.df$arch_level) 


levels(final.df$arch_level_sub)

final.df$ispleiotropy <- factor(final.df$ispleiotropy)
levels(final.df$ispleiotropy) <- c("No pleiotropy", "Pleiotropy")
head(final.df$ispleiotropy)

final.df$arch_level_sub <-
  factor(final.df$arch_level_sub,
  levels=c("1-trait", "2-trait-no-pleiotropy-equal-S",
           "2-trait-pleiotropy-equal-S",
           "2-trait-no-pleiotropy-unequal-S",
           "2-trait-pleiotropy-unequal-S"), ordered=TRUE)

levels(final.df$arch_level_sub) <- c("1 trait", "2 traits, no pleiotropy, equal S",
           "2 traits, pleiotropy, equal S",
           "2 traits, no pleiotropy, unequal S",
           "2 traits, pleiotropy, unequal S")


levels(final.df$arch_level_sub) <- c("1 trait", "2 traits\nno pleiotropy\nequal S",
           "2 traits\npleiotropy\nequal S",
           "2 traits\nno pleiotropy\nunequal S",
           "2 traits\npleiotropy\nunequal S")

final.df$demog_level <- factor(final.df$demog_level, levels=c("SS-Clines", "SS-Mtn", "Est-Clines"), ordered=TRUE)

final.df$demog_level_sub<- factor(final.df$demog_level_sub, levels=c("N-equal_m-constant", "N-equal_m_breaks", "N-cline-N-to-S_m-constant", "N-cline-center-to-edge_m-constant",  "N-variable_m-variable"), ordered=TRUE)

final.df$demog_level_sub <- as.factor(final.df$demog_level_sub)

levels(final.df$demog_level_sub)

levels(final.df$demog_level_sub) <- c("N equal\nm constant", "N equal\nm breaks", "N latitude cline\nm constant", "N central cline\nm constant",  "N variable\nm variable") #warning, make sure in same order as previous code
levels(final.df$demog_level_sub)
```

## Plot mean FST
```{r mean FST}

### Check for missing data
sum(is.na(final.df$meanFst))
summary(final.df$meanFst)
sum(is.na(final.df$arch_level_sub))
sum(is.na(final.df$demog_level))

### Table of mean FST for different levels - no evidence of missing data
tapply(final.df$meanFst, list(final.df$demog_level, final.df$demog_level_sub), mean)
tapply(final.df$meanFst, list(final.df$demog_level, final.df$demog_level_sub), length)

tapply(final.df$meanFst, list(final.df$demog_level, final.df$arch_level_sub), mean)
tapply(final.df$meanFst, list(final.df$demog_level, final.df$arch_level_sub), length)

### Distribution of FST as a funciton of architecture
f <- ggplot(final.df) + geom_histogram(aes(x=meanFst, fill=arch_level_sub), binwidth=0.01, color="grey") + ggtheme + 
  coord_cartesian(xlim = c(0.0, 0.5)) +   # does not give an error for bins with missing values
  #xlim(0,0.5) + #gives an error for bins with missing values
  facet_grid(demog_level~.) + scale_fill_viridis(option="magma", discrete=TRUE, name="Pleiotropy level") + xlab("Fst") + ylab("Number of simulations")  + theme(legend.position="bottom") +  guides(fill = guide_legend(reverse = TRUE)) + ggtitle("A")
f

pdf(paste0(outputs,"FST_Demog.pdf"), width=8, height=6)
### Distribution of FST as a funciton of demography
  ggplot(final.df) + geom_histogram(aes(x=meanFst, fill=demog_level_sub), binwidth=0.01, color="grey", na.rm=TRUE) + ggtheme + coord_cartesian(xlim = c(0, 0.5), ylim=c(0,160))  + facet_grid(demog_level~., scales="free") + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("Fst") + ylab("Number of simulations")  + theme(legend.position="bottom") + geom_hline(yintercept=0, color="white", size=1)  + geom_hline(yintercept=0, color="grey10", size=0.1)
  dev.off()

  ggplot(final.df) + geom_histogram(aes(x=meanFst, fill=demog_level_sub, position="stack"), binwidth=0.01, color="grey") + ggtheme + xlim(0,0.5) + facet_grid(demog_level~.) + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("Fst") + ylab("Number of simulations")  + theme(legend.position="bottom") 
  
ggplot(final.df, aes(x=as.factor(demog_level_sub), y=meanFst, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Demography") + ylab("overall FST") + scale_color_viridis(discrete=TRUE)  + ylim(0,0.5) + scale_fill_viridis(discrete=TRUE, name="Landscape")

a<-tapply(final.df$meanFst,final.df$demog_name, mean,  na.rm=TRUE)
b<- tapply(final.df$final_LA,final.df$demog_name, mean,  na.rm=TRUE)
  
cbind(Fst=a,LA=b)

ggplot(final.df, aes(x=as.factor(N_traits), y=meanFst, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("meanFst") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none") + ylim(0,1) 
```

## Degree local adaptation

Visualize the degree of local adapation
```{r LA}

summary(final.df$final_LA)

      l1 <- ggplot(final.df) + geom_histogram(aes(x=final_LA, fill=arch_level_sub), binwidth=0.01, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 0.75)) + facet_grid(demog_level~.) + scale_fill_viridis(option="magma", discrete=TRUE, name="Pleiotropy level") + xlab("Amount of local adaptation") + ylab("Number of simulations")  + theme(legend.position="bottom") +
  guides(fill = guide_legend(reverse = TRUE)) + ggtitle("A")  + geom_hline(yintercept=0, color="white", size=1)  + geom_hline(yintercept=0, color="grey10", size=0.1)
l1

ggplot(final.df) + geom_histogram(aes(x=final_LA, fill=demog_level_sub), binwidth=0.01, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 0.6)) + facet_grid(demog_level~.) + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("Amount of local adaptation") + ylab("Number of simulations")  + theme(legend.position="bottom") +
  guides(fill = guide_legend(reverse = FALSE)) + ggtitle("A")  + geom_hline(yintercept=0, color="white", size=1)  + geom_hline(yintercept=0, color="grey10", size=0.1)

l2<- ggplot(final.df) +
        geom_point(aes(x=subsamp_corr_phen_temp,
                       y=subsamp_corr_phen_sal,
                       color=final_LA,shape=demog_level)) + 
        ggtheme +
      scale_color_viridis(option="mako", name="Local\nAdaptation", begin=0.2, end=1) + coord_cartesian(xlim = c(0.25,1)) + ylim(0.25,1) + xlab("Cor(temp. phenotype, deme temperature)") + ylab("Cor(Env2 phenotype, deme Env2)") + ggtitle("B") +labs(shape="Landscape")  + geom_hline(yintercept=0, color="white", size=1)  + geom_hline(yintercept=0, color="grey10", size=0.1)
  l2
   # in this case, the removed points have an NA because the "sal" trait was not adaptive in 450 simulations:
  # ggplot(final.df, aes(x=as.factor(N_traits), y=meanFst, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("meanFst") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none") + ylim(0,1) + ggtitle("C")
  
  sum(is.na(final.df$subsamp_corr_phen_temp))
  sum(is.na(final.df$subsamp_corr_phen_sal))
  
pdf(paste0(outputs,"AmountLA.pdf"), width=7, height=8)
  grid.arrange(l1,l2, nrow=2)
dev.off()

```

## Number of loci
```{r plot num loci}

# Create a dataframe for plotting
numloc_df <- gather(final.df, key=filter, value=num_loci_causal, num_causal_prefilter, num_causal_postfilter)

numloc_df$filter <- factor(numloc_df$filter, levels = c("num_causal_prefilter", "num_causal_postfilter"), ordered=TRUE)

levels(numloc_df$filter) <- c("Pre MAF filter", "Post filter MAF > 0 .01")
str(numloc_df$filter)


tapply( numloc_df$num_loci_causal, list(numloc_df$filter,numloc_df$arch_level), mean, na.rm=TRUE)

str(numloc_df$arch_level)

# Plot QTN loci
m<- ggplot(numloc_df ) + geom_boxplot(aes(y=num_loci_causal,x = arch_level, fill=filter), color="grey70") + ggtheme + ylim(0,4000) + ylab("Number of causal loci") + xlab("Architecture") + scale_fill_viridis(option="mako", discrete=TRUE)
m

# Check no missing data
sum(is.na(final.df$num_neut_prefilter))
sum(is.na(final.df$num_neut_postfilter))

# Plot neutral loci
n <- ggplot(final.df) + geom_violin(aes(y=num_neut_postfilter, x=demog_level_sub, fill=demog_level), color="grey70") + ggtheme + ylab("Number of neutral loci\nafter sampling and MAF filter") + xlab("Demography") + guides(fill=guide_legend(title="Landscape"))
n

tapply(final.df$num_neut_postfilter, list(final.df$demog_level_sub), median, na.rm=TRUE)
tapply(final.df$num_neut_postfilter, list(final.df$demog_level_sub), mean, na.rm=TRUE)

pdf(paste0(outputs,"NumLociPrePostfilter.pdf"), width=7, height=8)
  grid.arrange(m, n, nrow=2)
dev.off()
```


## K (Number of populations)
```{r plot K}

# What determines K?
K_mod <- summary(aov(K~arch + demog_level_sub + demog_level + arch*demog_level_sub*demog_level, data=final.df))
K_mod

# Percent of variance (SS) explained by each
pervarK <- round(K_mod[[1]][,2]/sum(K_mod[[1]][,2]),2)
data.frame(name=rownames(K_mod[[1]]),pervarK)
  # mostly determined by demography

summary(final.df$K)

pdf(paste0(outputs,"K_by_demog.pdf"), width=6, height=6)
  ggplot(final.df) + geom_histogram(aes(x=K, fill=demog_level), binwidth=1, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 11)) + facet_grid(demog_level_sub~.) + scale_fill_viridis(option="viridis", discrete=TRUE, name="Demography") + xlab("Number of population clusters (K)") + ylab("Number of simulations")  + theme(legend.position="bottom") +
  guides(fill = guide_legend(reverse = FALSE))  + geom_hline(yintercept=0, color="white", size=1)  + geom_hline(yintercept=0, color="grey10", size=0.1)
dev.off()
```

## Statistical models

#### MODELS FOR DIVERGENCE (FST) AND FOR AMOUNT Local adaptation (LA)
```{r stat model LA and FST}
levels(final.df$arch)
levels(final.df$demog_level)
levels(final.df$demog_level_sub)

## ANOVA for degree LA
LA_mod <- summary(aov(final_LA~arch + demog_level_sub + demog_level + arch*demog_level_sub*demog_level, data=final.df))
LA_mod
## Perent of SS for each explanatory variable
pervarLA <- round(LA_mod[[1]][,2]/sum(LA_mod[[1]][,2]),2)

## ANOVA for FST
FST_mod <- summary(aov(meanFst ~ arch + demog_level_sub + demog_level + arch*demog_level_sub*demog_level, data=final.df))
FST_mod
## Perent of SS for each explanatory variable
pervarFST <- round(FST_mod[[1]][,2]/sum(FST_mod[[1]][,2]),2)

data.frame(name=rownames(FST_mod[[1]]),pervarLA, pervarFST)
```


#### MODELS FOR allele frequency (AF) clines
```{r stat model proportion of AF clines}

# Create a dataframe for analysis with both traits
stat_df <- gather(final.df, key=trait, value=cor_TPR, cor_TPR_temp, cor_TPR_sal)
tail(stat_df)

# Check the levels in the new dataframe
unique(stat_df$demog_level)
unique(stat_df$demog_level_sub)
unique(stat_df$demog_name)
unique(stat_df$arch_level_sub)
unique(stat_df$arch)


## Statistical model with both traits
  stat_df$trait <- factor(stat_df$trait)
  levels(stat_df$trait)
  levels(stat_df$N_traits)
  
  modelsum <- summary(aov(cor_TPR ~ trait + arch + demog + demog_level +  final_LA + arch*trait*demog, data=stat_df))
  modelsum
  
  ### Percent of variation (SS) explained by each explanatory variable
    pervar <- data.frame(variable = rownames(modelsum[[1]]), SS = modelsum[[1]][,2])
    pervar$pervar <- round(pervar$SS/sum(pervar$SS)*100, 1)
    pervar


## Statistical model with only temperature trait
  modelsum <- summary(aov(cor_TPR_temp ~ arch + demog + demog_level + final_LA + arch*demog*demog_level, data=final.df))
  pervar_temp <- data.frame(variable = rownames(modelsum[[1]]), SS = modelsum[[1]][,2])
  pervar_temp$pervar <- round(pervar_temp$SS/sum(pervar_temp$SS)*100, 1)
  pervar_temp

  ## Statistical model with only salinity trait
  modelsum <- summary(aov(cor_TPR_sal ~ arch + demog + demog_level +  final_LA + arch*demog*demog_level, data=final.df))
  pervar_sal <- data.frame(variable = rownames(modelsum[[1]]), SS = modelsum[[1]][,2])
  pervar_sal$pervar <- round(pervar_sal$SS/sum(pervar_sal$SS)*100, 1)
  pervar_sal

data.frame(variable = pervar_temp$variable, temp_AFcors = pervar_temp$pervar, sal_AFcors = pervar_sal$pervar)
```

# How does demography and genetic architecture contribute to the evolution of phenotypic clines without clines in causal allele frequencies?

## Number of loci with correlations - demog
```{r proportion of allele frequency clines}

# Plote temperatue clines as a function of number of traits and landscape
a<- ggplot(final.df, aes(x=as.factor(N_traits), y=cor_TPR_temp, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none") + ylim(0,1) + ggtitle("C")
a

# Plot Env2 clines as a function of landscape (only 2 trait simulations)
forb <- final.df[final.df$N_traits==2,]
forb$N_traits <- factor(forb$N_traits)
b<- ggplot(forb, aes(x=N_traits, y=cor_TPR_sal, fill=demog_level)) + geom_boxplot(color="grey") + ggtheme + xlab("Number of traits") + ylab("Proportion of causal Env2 \n loci with significant clines") + scale_color_viridis(discrete=TRUE) + ylim(0,1) + guides(fill=guide_legend(title="Landscape")) + ggtitle("D")
b


### Pleiotropy vs no pleiotropy - only relevant for sims with 2 traits
  subdf_arch <- final.df[final.df$N_traits==2,]
  unique(final.df$SIGMA_K_1)
  unique(subdf_arch$SIGMA_K_2)
  subdf_arch$SIGMA_K_2 <- as.factor(subdf_arch$SIGMA_K_2)
  my_col_arch <- c(viridis(10)[3], viridis(10)[7])
  
  # temp only
  f1 <-   ggplot(subdf_arch, aes(x=arch_level, y=cor_TPR_temp, fill=as.factor(ispleiotropy))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_fill_manual( values=my_col_arch, labels=c("No pleiotropy", "Pleiotropy"), name="2-trait architectures")  + ylim(0,1) #+ theme(legend.title=element_text("2-trait\narchitectures"))
  f1

  # env2 only
  f2 <-   ggplot(subdf_arch, aes(x=arch_level, y=cor_TPR_sal, fill=as.factor(ispleiotropy))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal sal. \n loci with significant clines") + scale_fill_manual( values=my_col_arch, labels=c("No pleiotropy", "Pleiotropy"), name="2-trait architectures")  + ylim(0,1) #+ theme(legend.title=element_text("2-trait\narchitectures"))
  f2

# Combine data together from f1 and f2 for a single plot
# because they both show the same pattern
pleiotropy.df <- gather(subdf_arch, key=trait, value=cor_TPR, cor_TPR_temp, cor_TPR_sal)

fboth <-   ggplot(pleiotropy.df, aes(x=arch_level, y=cor_TPR, fill=as.factor(ispleiotropy))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal \n loci with significant clines") + scale_fill_manual( values=my_col_arch, labels=c("No pleiotropy", "Pleiotropy"), name="2-trait architectures")  + ylim(0,1) + ggtitle("B")
fboth


## Phenotypic clines vs. af clines

### For each trait, I want to plot the (correlation between the trait and environment) vs. (correlation between af and environment)
final.df$N_traits2 <- final.df$N_traits
final.df$N_traits2[final.df$N_traits==1] <- "1 Trait"
final.df$N_traits2[final.df$N_traits==2] <- "2 Traits"
final.df$ispleiotropy <- factor(final.df$ispleiotropy)
head(final.df$ispleiotropy)

f3 <- ggplot(final.df) + 
  geom_point(aes(x=subsamp_corr_phen_temp, y=cor_TPR_temp, color=arch_level#,shape=ispleiotropy
                 ), alpha=0.6, fill="grey", shape=0) +  
  geom_point(aes(x=subsamp_corr_phen_sal, y=cor_TPR_sal, color=arch_level#, shape=ispleiotropy
                 ), alpha=0.6, fill="grey", shape=0) + 
  ggtheme + ylim(0,1) + xlim(0,1)  +  
  xlab("Correlation(phenotype, deme environment)") + 
  ylab("Proportion of causal \n loci with significant clines") + scale_color_viridis(name="Genic level", discrete=TRUE, option="rocket", begin=0, end=0.8) + #scale_shape_manual(values=c(0,19),name="Pleiotropy") + 
  ggtitle("A") #+ #+ facet_grid(~N_traits2) 
   # facet_grid(~arch_level_sub)
f3
# 450 missing values expected (simulations without the Env2 trait)

pdf(paste0(outputs,"WhatDrivesNonClines.pdf"), width=6, height=8)
  grid.arrange(f3, fboth,a,b, nrow=3, ncol=2, layout_matrix=matrix(c(1,1,2,2,3,4), nrow=3, byrow=TRUE))
# 450 missing values expected (simulations without the Env2 trait)
dev.off()

```

## Percent of Va explained by clinal loci

Same plots as above, but for the percent of the additive genetic variance (Va). If clinal loci explain a major proportion of Va, then it could be argued that QTN loci that do not have clinal patterns are not as "important" to discover.

```{r plot proportion of VA explained by clinal loci}

# Reorganize data for plotting
pleiotropy.df2 <- gather(subdf_arch, key=trait, value=cor_VA_prop, cor_VA_temp_prop, cor_VA_sal_prop)
pleiotropy.df3 <- gather(subdf_arch, key=trait, value=cor_TPR, cor_TPR_temp, cor_TPR_sal)

fboth2 <-   ggplot() + 
  geom_boxplot(aes(x=arch_level, y=cor_TPR), data=pleiotropy.df3, color="grey70", alpha=0.8, fill="grey90") +
  geom_boxplot(aes(x=arch_level, y=cor_VA_prop, fill=arch_level), data=pleiotropy.df2, color="grey20") + ggtheme + xlab("") + ylab("Proportion of explainable VA \n explained by loci with significant clines") + scale_fill_viridis(option="rocket", discrete=TRUE)  + ylim(0,1) + ggtitle("A") + theme(legend.position = "none")
fboth2

a1<- ggplot() + 
  geom_boxplot(aes(x=demog_level, y=cor_TPR_temp), data=final.df, color="grey70", alpha=0.8, fill="grey90") +
  geom_boxplot(data=final.df, aes(x=demog_level, y=cor_VA_temp_prop, fill=demog_level),color="grey20") + ggtheme + xlab("Landscape") + ylab("Proportion of explainable VA in temp. \n explained by loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none")+ ylim(0,1) + ggtitle("B")
a1

b1<- ggplot()+
    geom_boxplot(aes(x=demog_level, y=cor_TPR_sal), data=final.df, color="grey70", alpha=0.8, fill="grey90") +
  geom_boxplot(data=final.df, aes(x=demog_level, y=cor_VA_sal_prop, fill=demog_level),color="grey20") + ggtheme + xlab("Landscape") + ylab("Proportion of explainable VA in Env2 \n explained by loci with significant clines") + scale_color_viridis(discrete=TRUE) + theme(legend.position = "none")+ ylim(0,1) + ggtitle("C")
b1

pdf(paste0(outputs,"WhatDrivesNonClines_VA.pdf"), width=8, height=8)
  grid.arrange(fboth2, a1,b1, nrow=2, ncol=2, layout_matrix=matrix(c(1,1,2,3), nrow=2, byrow=TRUE))
dev.off()
```

## Demography sub level
```{r plot prop. clines as a function of demography}

unique(final.df$demog)
unique(final.df$demog_level)
unique(final.df$demog_level_sub)


pleiotropy.df$demog_level_sub <- as.factor(pleiotropy.df$demog_level_sub)
levels(pleiotropy.df$demog_level_sub) <- c("N equal\nm constant", "N equal\nm breaks", "N latitude cline\nm constant", "N central cline\nm constant",  "N variable\nm variable") # make sure in correct order




## Sub demograph - mako color

d1 <- ggplot(pleiotropy.df, aes(x=as.factor(demog_level_sub), y=cor_TPR, fill=as.factor(demog_level_sub))) + geom_boxplot(color="grey") + ggtheme + xlab("Demography") + ylab("Proportion of causal loci\nwith significant clines") + scale_fill_viridis(option="mako",discrete=TRUE) + theme(legend.position = "none") + theme( axis.text.x=element_text(angle=90,vjust=0.5, hjust=1, size = 10)) + ggtitle("A")
d1

## Strength of selection - magma color
my_col_S <- c(magma(10)[5], magma(10)[8])

s1<- ggplot(subdf_arch, aes(x=arch_level, y=cor_TPR_temp, fill=as.factor(SIGMA_K_2))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal temp. \n loci with significant clines") + scale_fill_manual( values=my_col_S, labels=c(
  expression(paste("Strong selection ", sigma[K]," = 0.5")), 
  expression(paste("Weak selection ", sigma[K]," = 4.0"))
  ), name="2-trait architectures")  + ylim(0,1) + xlab("Genetic architecture") + ggtitle("B")
s1

pdf(paste0(outputs,"WhatDrivesNonClines-subdemog-selection.pdf"), width=6, height=8)
  grid.arrange(d1, s1, nrow=2)
dev.off()
```



Does hanging strength of selection on trait 1 (temp)  affect the number of allee frequency clines that evolve in trait 2 (env2)? Graph suggests no.
```{r selection strength in opposite trait}
 #+ theme(legend.title=element_text("2-trait\narchitectures"))

ggplot(subdf_arch, aes(x=arch_level, y=cor_TPR_sal, fill=as.factor(SIGMA_K_2))) + geom_boxplot(color="grey") + ggtheme + xlab("") + ylab("Proportion of causal sal. \n loci with significant clines") + scale_fill_manual( values=my_col_S, labels=c("Strong selection on other trait (sigma_K=0.5)", "Weak selection on other trait (sigma_K=4)"), name="2-trait architectures")  + ylim(0,1) #+ theme(legend.title=element_text("2-trait\narchitectures"))

```


## Distribution of the correlation between structure and deme environment

```{r correlation between structure and deme environment}

sum(is.na(final.df$cor_PC1_temp))

# First PC axis with temp
sc1<- ggplot(final.df) + geom_histogram(aes(x=abs(cor_PC1_temp), fill=demog_level_sub), binwidth=0.05, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 1)) + facet_grid(demog_level~., scales = "free_y") + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("|Cor(PC1, deme Temperature)|") + ylab("Number of simulations")  + theme(legend.position="none") + ggtitle("A) Temperature")
sc1

# 2nd PC axis with temp
sc2<-ggplot(final.df) + geom_histogram(aes(x=abs(cor_PC2_temp), fill=demog_level_sub), binwidth=0.05, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 1)) + facet_grid(demog_level~., scales = "free_y") + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("|Cor(PC2, deme temp)|") + ylab("Number of simulations")  + theme(legend.position="none") 
sc2

# 1st PC axis with Env2
sc3<-ggplot(final.df) + geom_histogram(aes(x=abs(cor_PC1_sal), fill=demog_level_sub), binwidth=0.05, color="grey") + ggtheme + coord_cartesian(xlim = c(0, 1)) + facet_grid(demog_level~., scales = "free_y") + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography") + xlab("|Cor(PC1, deme Env2)|") + ylab("Number of simulations")  + ggtitle("B) Env2") + theme(legend.position="right")
sc3

# 2nd PC axis with Env2
sc4<-ggplot(final.df) + geom_histogram(aes(x=abs(cor_PC2_sal), fill=demog_level_sub), binwidth=0.05,  color="grey") + ggtheme + coord_cartesian(xlim = c(0, 1)) + facet_grid(demog_level~., scales = "free_y") + scale_fill_viridis(option="mako", discrete=TRUE, name="Demography level") + xlab("|Cor(PC2, deme Env2)|") + ylab("Number of simulations")  + theme(legend.position="bottom")
sc4

pdf(paste0(outputs,"StructureEnvCor_facetDemog.pdf"), width=12, height=9)
    grid.arrange(sc1, sc3, layout_matrix=matrix(c(1,1,1,2,2,2,2),
                                              nrow=1), nrow=1)
dev.off()

```

## Under what conditions can we reliably identify the alleles with effects on adaptive phenotypes using genetic-environment associations (latent factor mixed models, uncorrected correlations, and redundancy analysis)? 


## Compare methods AUC

AUC stands for area under the curve, here I use the Precision-Recall curve
```{r AUC}

# Check for missing data
sum(is.na(final.df$cor_AUCPR_temp_neutSNPs))
sum(is.na(final.df$cor_AUCPR_sal_neutSNPs)) #expected 450 missing
sum(is.na(final.df$LEA3.2_lfmm2_AUCPR_temp_neutSNPs))
sum(is.na(final.df$LEA3.2_lfmm2_AUCPR_sal_neutSNPs)) #expected 450 missing
sum(is.na(final.df$RDA_AUCPR_neutSNPs))
sum(is.na(final.df$RDA_AUCPR_neutSNPs_corr))

# Reorganize data for plotting
comparemethods.AUC <- gather(final.df, key=method, value=AUCPR, cor_AUCPR_temp_neutSNPs, LEA3.2_lfmm2_AUCPR_temp_neutSNPs, RDA_AUCPR_neutSNPs, RDA_AUCPR_neutSNPs_corr, cor_AUCPR_sal_neutSNPs,
                                  LEA3.2_lfmm2_AUCPR_sal_neutSNPs)


levels(factor(comparemethods.AUC$method))

comparemethods.AUC$methodtype <- factor(comparemethods.AUC$method)

comparemethods.AUC$methodtype <- 
  revalue(comparemethods.AUC$methodtype,
          c(
            "cor_AUCPR_temp_neutSNPs"= "Cor(p, Temp.)",  
            "LEA3.2_lfmm2_AUCPR_temp_neutSNPs" = "LFMM - Temp",
            "cor_AUCPR_sal_neutSNPs"="Cor(p, Env2)", 
            "LEA3.2_lfmm2_AUCPR_sal_neutSNPs" = "LFMM - Env2",
            "RDA_AUCPR_neutSNPs"  = "RDA",        
             "RDA_AUCPR_neutSNPs_corr" = "pRDA (with\nstructure correction)"  ))

comparemethods.AUC$methodtype <- factor(comparemethods.AUC$methodtype,
                                        levels = c("Cor(p, Temp.)",
                                                   "LFMM - Temp",
                                                   "Cor(p, Env2)",
                                                   "LFMM - Env2",
                                                   "RDA",
                                                    "pRDA (with\nstructure correction)"),
                                        ordered=TRUE)

# Sanity checks  
levels(comparemethods.AUC$methodtype)
table(comparemethods.AUC$methodtype)

summary(comparemethods.AUC$AUCPR)

# Across all simulations, AUCPR
g <- ggplot(comparemethods.AUC, aes(x=as.factor(methodtype), y=AUCPR)) + geom_boxplot(color="grey",  fill="cornflowerblue") + ggtheme + xlab("method") + ylab("AUC-PR\n(worse <<--->> better)")   + theme( axis.text.x=element_text(angle=90,vjust=0.5, hjust=1, size = 10)) + scale_color_viridis(name="Landscape", discrete=TRUE) + guides(fill=guide_legend(title="Landscape")) +ggtitle("A")
g
# tried a violin plot, but the boxplot is better
# 450 NAs are expected for the Env2 models
tapply(comparemethods.AUC$AUCPR,comparemethods.AUC$methodtype, function(x){sum(is.na(x))})

```



## Compare methods FDR

False discovery rate (FDR) is the proportion of positive tests that are true positives. If there are no positive tests, then the statistic is undefined (NA).
```{r}

#Check for NAs in temperature models
  sum(is.na(final.df$cor_FDR_neutSNPs_temp))
  sum(is.na(final.df$LEA3.2_lfmm2_FDR_neutSNPs_temp))
    # A lot of NAs here
  # check that the NAs come from cases with 0 positive tests
  Totalsig <- final.df$LEA3.2_lfmm2_num_causal_sig_temp +final.df$LEA3.2_lfmm2_num_neut_sig_temp 

  summary(Totalsig)
  plot(is.na(final.df$LEA3.2_lfmm2_FDR_neutSNPs_temp)~Totalsig==0)
    # This confirms when there are no outliers (Totalsig==0), the FDR is NA
  
  tapply(is.na(final.df$LEA3.2_lfmm2_FDR_neutSNPs_temp), 
         list(final.df$demog_level, final.df$demog_level_sub), sum)
      ## NAs are evenly spread across the demographies, but slightly higher in the SS scenarios
    tapply(is.na(final.df$LEA3.2_lfmm2_FDR_neutSNPs_temp), 
         list(final.df$demog_level), sum)
        tapply(is.na(final.df$LEA3.2_lfmm2_FDR_neutSNPs_temp), 
         list(final.df$demog_level_sub), sum)
  
  boxplot(abs(final.df$cor_LFMMU1_temp)~ !Totalsig==0, 
          ylab="|Cor(deme temperature, LFMM U1 loading)|",
          xlab="Number of outliers",
          names=c("0", "more than 0"))
    #  But NA does not seem to be affected by correlations between latent factor and deme environment


    
# Check for NAs in salinity model
  sum(is.na(final.df$cor_FDR_neutSNPs_sal))
    plot(is.na(final.df$cor_FDR_neutSNPs_sal)~
             (final.df$cor_af_sal_noutliers)==0)
    # I think there is an issue with the noutliers here, need to fix
    TO DO
    summary(final.df$cor_af_sal_noutliers)
    
  sum(is.na(final.df$LEA3.2_lfmm2_FDR_neutSNPs_sal))
   # check that the NAs come from cases with 0 positive tests
  Totalsig_sal <- final.df$LEA3.2_lfmm2_num_causal_sig_sal #+ MISSING SECOND VARIABLE if want total outliers
  summary(Totalsig_sal)
  plot(is.na(final.df$LEA3.2_lfmm2_FDR_neutSNPs_sal)~Totalsig_sal==0)
  
     boxplot(abs(final.df$cor_LFMMU1_sal)~ !Totalsig_sal==0, 
          ylab="|Cor(PC1 loading, LFMM U1 loading)|",
          xlab="Number of outliers",
          names=c("0", "more than 0"), main= "LFMM Env2. model") 

#Check for NAs in RDA model
  sum(is.na(final.df$RDA_FDR_neutSNPs))
  sum(is.na(final.df$RDA_FDR_neutSNPs_corr))


# reorganize data for plotting
comparemethods.FDR <- gather(final.df, key=method, value=FDR, cor_FDR_neutSNPs_temp, LEA3.2_lfmm2_FDR_neutSNPs_temp, RDA_FDR_neutSNPs, RDA_FDR_neutSNPs_corr, cor_FDR_neutSNPs_sal, LEA3.2_lfmm2_FDR_neutSNPs_sal)

comparemethods.FDR <- comparemethods.FDR[order(comparemethods.FDR$seed),]
tail(comparemethods.FDR)

comparemethods.FDR$methodtype <- factor(comparemethods.FDR$method)

levels(comparemethods.FDR$methodtype)

comparemethods.FDR$methodtype <- revalue(comparemethods.FDR$methodtype,
                                         c("cor_FDR_neutSNPs_sal"="Cor(p, Env2)", 
                                           "cor_FDR_neutSNPs_temp"= "Cor(p, Temp.)",  
                                           "LEA3.2_lfmm2_FDR_neutSNPs_sal" = "LFMM - Env2 (with\nstructure correction)",
                                           "LEA3.2_lfmm2_FDR_neutSNPs_temp" = "LFMM - Temp. (with\nstructure correction)",
                                           "RDA_FDR_neutSNPs"  = "RDA"   ,        
                                           "RDA_FDR_neutSNPs_corr" = "pRDA (with\nstructure correction)"  ))

comparemethods.FDR$methodtype <- factor(comparemethods.FDR$methodtype,
                                        levels = c("Cor(p, Temp.)",
                                                   "LFMM - Temp. (with\nstructure correction)",
                                                   "Cor(p, Env2)",
                                                   "LFMM - Env2 (with\nstructure correction)",
                                                   "RDA",
                                                    "pRDA (with\nstructure correction)"),
                                        ordered=TRUE)

table(comparemethods.FDR$methodtype)  

tapply(comparemethods.FDR$FDR,comparemethods.AUC$methodtype, function(x){sum(is.na(x))})

g2<- ggplot(comparemethods.FDR, aes(x=as.factor(methodtype), y=FDR)) + geom_boxplot(color="grey", fill="cornflowerblue") + ggtheme + xlab("method") + ylab("FDR\n(better <<--->> worse)") + scale_fill_viridis(option="turbo", discrete=TRUE) + theme(legend.position = "none") + theme( axis.text.x=element_text(angle=60, vjust=1, hjust=1, size = 10)) + ggtitle("B")
g2

# There are more NAs because FDR has NAs for cases with no true positives (no power)
```


## Compare methods POWER
Ideally, we would like power to be the same after correcting for pop structure as before we correct.
```{r}

#Check for NAs in temperature models
  sum(is.na(final.df$cor_TPR_temp))
  sum(is.na(final.df$LEA3.2_lfmm2_TPR_temp))
    # A lot of NAs here
  # check that the NAs come from cases with 0 positive tests
  Totalsig <- final.df$LEA3.2_lfmm2_num_causal_sig_temp +final.df$LEA3.2_lfmm2_num_neut_sig_temp 

  tapply(is.na(final.df$LEA3.2_lfmm2_TPR_temp), 
         list(final.df$demog_level, final.df$demog_level_sub), sum)
      ## NAs are evenly spread across the demographies, but slightly higher in the SS scenarios
    tapply(is.na(final.df$LEA3.2_lfmm2_TPR_temp), 
         list(final.df$demog_level), sum)
        tapply(is.na(final.df$LEA3.2_lfmm2_TPR_temp), 
         list(final.df$demog_level_sub), sum)

    
# Check for NAs in salinity model
  sum(is.na(final.df$cor_TPR_sal)) #450 expected
  sum(is.na(final.df$LEA3.2_lfmm2_TPR_sal))
  

#Check for NAs in RDA model
  sum(is.na(final.df$RDA_TPR))
  sum(is.na(final.df$RDA_TPR))


# reorganize data for plotting
comparemethods.TPR <- gather(final.df, key=method, value=TPR, cor_TPR_temp, LEA3.2_lfmm2_TPR_temp, RDA_TPR, RDA_TPR_corr, cor_TPR_sal, LEA3.2_lfmm2_TPR_sal)

comparemethods.TPR <- comparemethods.TPR[order(comparemethods.TPR$seed),]
tail(comparemethods.TPR)

comparemethods.TPR$methodtype <- factor(comparemethods.TPR$method)

levels(comparemethods.TPR$methodtype)

comparemethods.TPR$methodtype <- revalue(comparemethods.TPR$methodtype,
                                         c("cor_TPR_sal"="Cor(p, Env2)", 
                                           "cor_TPR_temp"= "Cor(p, Temp.)",  
                                           "LEA3.2_lfmm2_TPR_sal" = "LFMM - Env2 (with\nstructure correction)",
                                           "LEA3.2_lfmm2_TPR_temp" = "LFMM - Temp. (with\nstructure correction)",
                                           "RDA_TPR"  = "RDA"   ,        
                                           "RDA_TPR_corr" = "pRDA (with\nstructure correction)"  ))

comparemethods.TPR$methodtype <- factor(comparemethods.TPR$methodtype,
                                        levels = c("Cor(p, Temp.)",
                                                   "LFMM - Temp. (with\nstructure correction)",
                                                   "Cor(p, Env2)",
                                                   "LFMM - Env2 (with\nstructure correction)",
                                                   "RDA",
                                                    "pRDA (with\nstructure correction)"),
                                        ordered=TRUE)

table(comparemethods.TPR$methodtype)  

g3<- ggplot(comparemethods.TPR, aes(x=as.factor(methodtype), y=TPR)) + geom_boxplot(color="grey", fill="cornflowerblue") + ggtheme + xlab("method") + ylab("TPR\n(worse <<--->> better)") + scale_fill_viridis(option="turbo", discrete=TRUE) + theme(legend.position = "none") + theme( axis.text.x=element_text(angle=60, vjust=1, hjust=1, size = 10)) + ggtitle("C")
g3

pdf(paste0(outputs,"AUC-PR_FDR_TPR.pdf"), width=5, height=11)
grid.arrange(g+ theme( axis.text.x = element_blank(), axis.title.x=element_blank()),
             g2+ theme( axis.text.x = element_blank(), axis.title.x=element_blank()),
             g3,
             layout_matrix=matrix(c(1,1,1,2,2,2,3,3,3,3,3), nrow=11))
dev.off()
```

# LFMM - TPR vs STRUCTURE

* If overcorrected, then expect power to decrease as the correlation between the latent factor and env
```{r LFMM TPR vs STRUCTURE}

### THIS IS THE GRAPH
# Fix colors for arch_level_sub, 
# rename legend and make it taller, 
# reorder the legend levels
# For the 2nd legend, there is no "1 trait sims"

k1p <- ggplot(final.df) + geom_point(aes(x=abs(cor_LFMMU1_temp),y=LEA3.2_lfmm2_TPR_temp, color=arch_level_sub, shape=arch_level_sub)) + ggtheme + 
  xlab("|Cor(LFMM U1, Deme Temperature)|") + 
  ylab("TPR (LFMM Temp. Model)") +  
  scale_fill_viridis(option="magma", discrete=TRUE) +  
  scale_color_viridis(option="magma", discrete=TRUE, begin=0, end=0.9) + 
  geom_smooth(aes(x=abs(cor_LFMMU1_temp),y=LEA3.2_lfmm2_TPR_temp, color=arch_level_sub), alpha=0.2, method="lm", size=0.5) + ggtitle("A) Temp model") +
  ylim(0,1)  +xlim(0,1) + facet_wrap(~arch_level) + theme(legend.position = "none")
k1p # was not easy to change the color scheme here + scale_fill_viridis(option="mako", discrete=TRUE)

k2p <- ggplot(final.df) + 
  geom_point(aes(x=abs(cor_LFMMU1_sal),y=LEA3.2_lfmm2_TPR_sal, color=arch_level_sub, shape=arch_level_sub)) + ggtheme + 
  xlab("|Cor(LFMM U1, Deme Env2)|") + ylab("TPR (LFMM Env2 Model)") +
  geom_smooth(aes(x=abs(cor_LFMMU1_sal),y=LEA3.2_lfmm2_TPR_sal, color=arch_level_sub), alpha=0.2, method="lm", size=0.5) + 
  ylim(0,1) +xlim(0,1) + ggtitle("B) Env2 model") +
  scale_fill_viridis(option="magma", discrete=TRUE) + 
  scale_color_viridis(option="magma", discrete=TRUE, begin=0, end=0.9)  + 
  facet_wrap(~arch_level) + theme(legend.position = "bottom") 
k2p

pdf(paste0(outputs,"LFMM-TPRvsStructure.pdf"), width=8, height=8)

grid.arrange(k1p,k2p, nrow=2)
# 450 missing values expected here

dev.off()
```


## RDA checks

```{r}
#will be able to do with new outputs

par(mfrow=c(2,2))
sum(is.na(final.df$RDA_RDAmutpred_cor_tempEffect))
sum(is.na(final.df$RDA_RDAmutpred_cor_salEffect)) #450 expected

sum(is.na(final.df$RDA_cor_RDA20000temppredict_tempPhen))
sum(is.na(final.df$RDA_cor_RDA20000salpredict_salPhen))  #450 expected

# Seeds with really bad performance (no structure correction)
final.df$seed[which(final.df$RDA_RDAmutpred_cor_tempEffect < 0)]
final.df$seed[which(final.df$RDA_RDAmutpred_cor_salEffect < 0)]
final.df$seed[which(final.df$RDA_cor_RDA20000temppredict_tempPhen < 0)]
final.df$seed[which(final.df$RDA_cor_RDA20000salppredict_salPhen < 0)]
```

## Can redundancy analysis identify mutations with pleiotropic effects?
```{r RDA mutation prediction ~ architecture}

g1<- ggplot(final.df, aes(x=RDA_RDAmutpred_cor_tempEffect, fill=arch_level)) + geom_histogram(color="grey40", binwidth=0.05) + ggtheme + coord_cartesian(xlim = c(-1, 1)) + xlab("Cor(QTN effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="rocket", discrete=TRUE) + theme(legend.position = "none") + ggtitle("A) Temperature mutation effect")
g1 

g2 <- ggplot(final.df, aes(x=RDA_RDAmutpred_cor_salEffect, fill=arch_level)) + geom_histogram(color="grey40", binwidth=0.05) + ggtheme+ coord_cartesian(xlim = c(-1, 1))  + xlab("Cor(QTN effect on Env2,\nRDA-predicted Env2 effect)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="rocket", discrete=TRUE) + theme(legend.position="bottom") + ggtitle("B) Env2 mutation effect") 
g2
# removing 450 expected

  grid.arrange(g1, g2,
               layout_matrix = matrix(c(1,1,1,2,2,2,2), nrow=7))

# They show the same pattern, so combine for analysis:
forhist <- gather(final.df, key=env, value=Accuracy, RDA_RDAmutpred_cor_tempEffect, RDA_RDAmutpred_cor_salEffect)

g3 <- ggplot(forhist, aes(x=Accuracy, fill=arch_level)) + geom_histogram(color="grey40", binwidth=0.05) + ggtheme + coord_cartesian(xlim = c(-1, 1))  + xlab("Accuracy\nCor(evolved effect size,\n predicted effect size from RDA)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="rocket", discrete=TRUE) +  ggtitle("C) Accuracy of RDA prediction \n     (QTN effect size)") 
g3
# 450 missing values expected

```

Same analysis as above, but with structure correction

```{r RDA mutation prediction ~ architecture with structure correction}
g1sc<- ggplot(final.df, aes(x=RDA_RDAmutpred_cor_tempEffect_structcorr, fill=arch_level)) + geom_histogram(color="grey40", binwidth=0.05) + ggtheme + coord_cartesian(xlim = c(-1, 1))  + xlab("Cor(QTN effect on temp,\nRDA-predicted temp. effect)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="rocket", discrete=TRUE) + theme(legend.position = "none") + ggtitle("A) Temperature mutation effect with structure correction")
g1sc

g2sc <- ggplot(final.df, aes(x=RDA_RDAmutpred_cor_salEffect_structcorr, fill=arch_level)) + geom_histogram(color="grey40", binwidth=0.05) + ggtheme +  coord_cartesian(xlim = c(-1, 1))  + xlab("Cor(QTN effect on Env2,\nRDA-predicted Env2 effect)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="rocket", discrete=TRUE) + theme(legend.position="bottom") + ggtitle("B) Env2 mutation effect with structure correction") 
g2sc

grid.arrange(g1sc, g2sc,
               layout_matrix = matrix(c(1,1,1,2,2,2,2), nrow=7))


```

Another way to view the structure correction - boxplot

```{r RDA mutation prediction effect of structure correction}
library(plyr)
### Temp 
  
  #### Check for missing data
  sum(is.na(final.df$RDA_RDAmutpred_cor_tempEffect))
  sum(is.na(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr))
  
  #### organize data
  RDA_mutpredict <- gather(final.df, key=structcorr, value=Accuracy, RDA_RDAmutpred_cor_tempEffect, RDA_RDAmutpred_cor_tempEffect_structcorr)
  
  RDA_mutpredict$demog_level <- factor(RDA_mutpredict$demog_level)
  RDA_mutpredict$structcorr <- factor(RDA_mutpredict$structcorr)
  RDA_mutpredict$structcorr <- revalue(RDA_mutpredict$structcorr,c( "RDA_RDAmutpred_cor_tempEffect" = "No (RDA)",                                                           "RDA_RDAmutpred_cor_tempEffect_structcorr" = "Yes (pRDA)"))
  levels(RDA_mutpredict$structcorr)
  
  # check again for missing data
  sum(is.na(RDA_mutpredict$Accuracy))
  
  n <- ggplot(RDA_mutpredict, aes(y=Accuracy,x=demog_level, fill=structcorr)) + geom_boxplot(color="grey40") + ggtheme  +  coord_cartesian(ylim = c(-1, 1))   + ylab("Accuracy of RDA prediction\n(worse <<----->> better)") + ggtitle("D) QTN effect size on Temp.")  + guides(fill=guide_legend(title="Structure\nCorrection?")) + 
    theme(axis.text.x=element_blank()) + xlab("")
  # Cor(Mutation effect on Temp.,\nRDA-predicted Temp. effect)
  n
  # 450 rows


### Sal
  RDA_mutpredict_sal <- gather(final.df, key=structcorr, value=Accuracy, RDA_RDAmutpred_cor_salEffect, RDA_RDAmutpred_cor_salEffect_structcorr)
  
  RDA_mutpredict_sal$demog_level <- factor(RDA_mutpredict_sal$demog_level)
  RDA_mutpredict_sal$structcorr <- factor(RDA_mutpredict_sal$structcorr)
  RDA_mutpredict_sal$structcorr <- revalue(RDA_mutpredict_sal$structcorr,c( "RDA_RDAmutpred_cor_salEffect" = "No (RDA)",                                                           "RDA_RDAmutpred_cor_salEffect_structcorr" = "Yes (pRDA)"))
  levels(RDA_indpredict$structcorr)
  
  # check for NA values
    sum(is.na(RDA_mutpredict_sal$Accuracy))
    # 900 expected (450 from each set combined to one data frame)
  
  o <- ggplot(RDA_mutpredict_sal, aes(y=Accuracy,x=demog_level, fill=structcorr)) + geom_boxplot(color="grey40") + ggtheme +  coord_cartesian(ylim = c(-1, 1))    +  ylab("Accuracy of RDA prediction \n(worse <<----->> better)") + ggtitle("E) QTN effect size on Env2")  + guides(fill=guide_legend(title="Structure\nCorrection?"))  + xlab("Landscape")
  # "Cor(Mutation effect on Env2,\nRDA-predicted Env2 effect)"
  o

pdf(paste0(outputs,"RDA-Predict-Muts.pdf"), width=5, height=7)
  grid.arrange(g3, n,o)
dev.off()
```

What drives the population correction effect?
```{r RDA mutation effect structure correction}
############
## Temp
############
## What drives the change in performance with structure correction?
final.df$change_temp_mut <- final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect

summary(aov(final.df$change_temp_mut~final.df$cor_PC1_temp + final.df$cor_PC2_temp + 
              final.df$demog_level + final.df$demog_level_sub + final.df$arch_level))

p1 <- ggplot(final.df) + 
  geom_point(aes(x=abs(cor_PC1_temp), y=change_temp_mut, color=demog_level, shape=demog_level_sub), alpha=0.5) + ggtheme + 
  ylab("Change in accuracy\nafter structure correction\n(worse <<------->> better)") + xlab("|Cor(Structure as PC1, Temp)|") + 
  guides(color=guide_legend(title="Landscape"), shape=guide_legend("Demography")) + ggtitle("A) Mutation effect on Temperature") +  coord_cartesian(ylim = c(-1, 1))   + 
  geom_smooth(aes(x=abs(cor_PC1_temp),y=change_temp_mut, color=demog_level, fill=demog_level), alpha=0.2, method="loess", span=1)  + scale_fill_discrete(guide="none") + geom_hline(yintercept=0, color="black")
p1


#####################
## Env 2 trait
#####################

## What drives the change in performance with structure correction?
final.df$change_sal_mut <- final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect
summary(aov(final.df$change_sal_mut~final.df$cor_PC1_sal+ final.df$cor_PC2_sal + 
              final.df$demog_level + final.df$demog_level_sub + final.df$arch_level))


p2 <- ggplot(final.df) + geom_point(aes(x=abs(cor_PC1_sal), y=change_sal_mut, color=demog_level, shape=demog_level_sub), alpha=0.5) + ggtheme + ylab("Change in accurcay\nafter structure correction\n(worse <<------->> better)") + xlab("|Cor(Structure as PC1, Env2)|") + guides(color=guide_legend(title="Landscape"), shape=guide_legend("Demography")) + ggtitle("B) Mutation effect on Env2")  +  coord_cartesian(ylim = c(-1, 1))   + 
  geom_smooth(aes(x=abs(cor_PC1_sal),y=change_sal_mut, color=demog_level, fill=demog_level), alpha=0.2, method="loess", span=1) + scale_fill_discrete(guide="none") + geom_hline(yintercept=0, color="black")
p2


pdf(paste0(outputs,"RDA-Predict-Muts-CovariateStructure.pdf"), width=6, height=7)
  grid.arrange(p1, p2)
dev.off()


```




## Under what conditions can redundancy analysis predict an individual’s optimal environment, without knowledge of the genetic architecture of adaptation?


Visualize the effect of genetic architecture on phenotype prediction
```{r RDA phenotype prediction}
forhist <- gather(final.df, key=env, value=Accuracy, RDA_cor_RDA20000temppredict_tempPhen, RDA_cor_RDA20000salpredict_salPhen)

g4 <- ggplot(forhist, aes(x=Accuracy, fill=arch_level)) + geom_histogram(color="grey40", binwidth=0.05) + ggtheme +  coord_cartesian(xlim = c(-1, 1))   + xlab("Accuracy\nCor(evolved phenotype,\n predicted phenotype from RDA)") + guides(fill=guide_legend(title="Genetic\nArchitecture")) + scale_fill_viridis(option="rocket", discrete=TRUE) +  ggtitle("B) Accuracy of RDA prediction \n     (individual environmental trait, no structure correction)") 
g4
```


Accuracy of RDA prediction maxed out by cor (phenotype, Env)

```{r RDA trait prediction what explains it}
#Scatterplot

levels(final.df$demog_level_sub)
  
n1 <- ggplot(final.df[order(final.df$demog_level_sub, decreasing=TRUE),]) +   geom_point(aes(x=subsamp_corr_phen_temp,
                   y=RDA_cor_RDA20000temppredict_tempPhen, color=demog_level,
	                   shape=demog_level_sub), bg="red",alpha=0.3) + ylim(0,1) + xlim(0,1) +
     ggtheme + geom_abline(slope=1, color="grey") + 
  scale_shape_manual(values = c(0, 1, 10, 11, 21), name="Demography") + guides(color=guide_legend(title="Landscape")) +
  xlab("Evolved phenotypic cline\nCor(Temp. phenotype, Deme Temp.)") +
  ylab("Prediction accuracy\nCor(RDA prediction,\nTemp. phenotype)") + ggtitle("C) Accuracy of RDA prediction\n     (Temp. trait, no structure correction)")
  
n1 

n2<-  ggplot(final.df[order(final.df$demog_level_sub, decreasing=TRUE),]) +   geom_point(aes(x=subsamp_corr_phen_sal,
                   y=RDA_cor_RDA20000salpredict_salPhen, color=demog_level,
	                   shape=demog_level_sub), alpha=0.3, bg="red") + ylim(0,1) + xlim(0,1) + 
     ggtheme + geom_abline(slope=1, color="grey") + 
  scale_shape_manual(values = c(0, 1, 10, 11, 21), name="Demography") + guides(color=guide_legend(title="Landscape")) +
  xlab("Evolved phenotypic cline\nCor(Env2 phenotype, Deme Env2)") +
  ylab("Prediction accuracy\nCor(RDA prediction,\nEnv2 phenotype)")  +
  ggtitle("D) Accuracy of RDA prediction\n     (Env2 trait, no structure correction)")
n2  
# 450 missing values expected

pdf(paste0(outputs,"RDA-Demog-scatter.pdf"), width=6, height=10)
  grid.arrange(g4,  n1,  n2, ncol=1)
dev.off()

```

# Effect of structure correction

```{r RDA trait prediction effect of structure}

# Reorganize data
RDA_indpredict <- gather(final.df, key=structcorr, value=Accuracy, RDA_cor_RDA20000temppredict_tempPhen, RDA_cor_RDA20000temppredict_tempPhen_structcorr)

RDA_indpredict$demog_level <- factor(RDA_indpredict$demog_level)
RDA_indpredict$structcorr <- factor(RDA_indpredict$structcorr)
RDA_indpredict$structcorr <- revalue(RDA_indpredict$structcorr,c( "RDA_cor_RDA20000temppredict_tempPhen" = "No (RDA)", "RDA_cor_RDA20000temppredict_tempPhen_structcorr" = "Yes (pRDA)"))
levels(RDA_indpredict$structcorr)

n <- ggplot(RDA_indpredict, aes(y=Accuracy,x=demog_level, fill=structcorr)) + geom_boxplot(color="grey40") + ggtheme + ylim(-1,1) + ylab("Accuracy\nCor(evolved Temp. phenotype,\n predicted Temp. phenotype from RDA)") + ggtitle("A) Accuracy of RDA prediction\n      (Temp. phenotype)")  + guides(fill=guide_legend(title="Structure\nCorrection?")) + xlab("Landscape")
n


## Same as above for Env2 trait
RDA_indpredict_sal <- gather(final.df, key=structcorr, value=Accuracy, RDA_cor_RDA20000salpredict_salPhen, RDA_cor_RDA20000salpredict_salPhen_structcorr)

RDA_indpredict_sal$demog_level <- factor(RDA_indpredict_sal$demog_level)
RDA_indpredict_sal$structcorr <- factor(RDA_indpredict_sal$structcorr)
RDA_indpredict_sal$structcorr <- revalue(RDA_indpredict_sal$structcorr,c( "RDA_cor_RDA20000salpredict_salPhen" = "No (RDA)", "RDA_cor_RDA20000salpredict_salPhen_structcorr" = "Yes (pRDA)"))
levels(RDA_indpredict_sal$structcorr)

o <- ggplot(RDA_indpredict_sal, aes(y=Accuracy,x=demog_level, fill=structcorr)) + geom_boxplot(color="grey40") + ggtheme + ylim(-1,1) + ylab("Accuracy\nCor(evolved Env2. phenotype,\n predicted Env2. phenotype from RDA)") + ggtitle("B) Accuracy of RDA prediction\n      (Env2. phenotype)")  + guides(fill=guide_legend(title="Structure\nCorrection?")) + xlab("Landscape")
o
# 900 missing values expected


pdf(paste0(outputs,"RDA-Predict-Phen-struct.pdf"), width=5, height=7)
  grid.arrange(n, o)
dev.off()
```

Understand how correlation with PC affects structure correction
```{r RDA trait prediction effect of structure correction}


## Temp
## What drives the change in performance with structure correction?
final.df$change_temp <- final.df$RDA_cor_RDA20000temppredict_tempPhen_structcorr - final.df$RDA_cor_RDA20000temppredict_tempPhen

summary(aov(final.df$change_temp~final.df$cor_PC1_temp + final.df$cor_PC2_temp + 
              final.df$demog_level + final.df$demog_level_sub + final.df$arch_level))

p1 <- ggplot(final.df) + 
  geom_point(aes(x=abs(cor_PC1_temp), y=change_temp, color=demog_level, shape=demog_level_sub), alpha=0.5) + ggtheme + 
  ylab("Change in accuracy\nafter structure correction\n(worse <<------->> better)") + xlab("|Cor(Structure as PC1, Temp)|") + 
  guides(color=guide_legend(title="Landscape"), shape=guide_legend("Demography")) + ggtitle("A) Temperature Phenotype") + ylim(-1,1) + 
  geom_smooth(aes(x=abs(cor_PC1_temp),y=change_temp, color=demog_level, fill=demog_level), alpha=0.2, method="loess", span=1)  + scale_fill_discrete(guide="none")
p1

#####################
## Env 2 trait
#####################

## What drives the change in performance with structure correction?
final.df$change_sal <- final.df$RDA_cor_RDA20000salpredict_salPhen_structcorr - final.df$RDA_cor_RDA20000salpredict_salPhen
summary(aov(final.df$change_sal~final.df$cor_PC1_sal+ final.df$cor_PC2_sal + 
              final.df$demog_level + final.df$demog_level_sub + final.df$arch_level))


p2 <- ggplot(final.df) + geom_point(aes(x=abs(cor_PC1_sal), y=change_sal, color=demog_level, shape=demog_level_sub), alpha=0.5) + ggtheme + ylab("Change in accuracy\nafter structure correction\n(worse <<------->> better)") + xlab("|Cor(Structure as PC1, Env2)|") + guides(color=guide_legend(title="Landscape"), shape=guide_legend("Demography")) + ggtitle("B) Env2 Phenotype") + ylim(-1,1) + 
  geom_smooth(aes(x=abs(cor_PC1_sal),y=change_sal, color=demog_level, fill=demog_level), alpha=0.2, method="loess", span=1) + scale_fill_discrete(guide="none")
p2

pdf(paste0(outputs,"RDA-Predict-Traits-CovariateStructure.pdf"), width=6, height=7)
  grid.arrange(p1, p2)
dev.off()
#hist(final.df$cor_RDA20000_RDloadings_tempPhen, xlim=c(0,1), breaks=seq(0,1,0.05))
#hist(final.df$cor_RDA20000_RDloadings_salPhen, xlim=c(0,1), breaks=seq(0,1,0.05))
```

Well, this is interesting. The accuracy of the mutation loadings on the RDA axis is much lower for the highly polygenic architectures. Which makes sense.

The ironic thing is that the phenotypic prediction from the RDA is still accurate, and it is affected more by the degree that the phenotype is correlated with the environment. This can be explained by the Central Limit Theorem.

### Statistical models
```{r}
length(levels(final.df$arch))

# Stat models for temperature effect prediction
  tm_me <- summary(aov(RDA_RDAmutpred_cor_tempEffect~ subsamp_corr_phen_temp + demog_level + demog_level_sub + arch + demog_level*demog_level_sub*arch, data=final.df))
  tm_me
  
  sm_me <- summary(aov(RDA_RDAmutpred_cor_salEffect~ subsamp_corr_phen_temp + demog_level + demog_level_sub + arch + demog_level*demog_level_sub*arch, data=final.df))
  sm_me
  
 

# STat models for phenotype prediction
tm_pp <- summary(aov(RDA_cor_RDA20000temppredict_tempPhen~ subsamp_corr_phen_temp + demog_level + demog_level_sub + arch + demog_level*demog_level_sub*arch, data=final.df))
tm_pp

sm_pp <- summary(aov(RDA_cor_RDA20000salpredict_salPhen~ subsamp_corr_phen_sal + demog_level + demog_level_sub + arch + demog_level*demog_level_sub*arch, data=final.df))
sm_pp

 # Calculate proportion of variance explained in SS
 z<- data.frame(
        PropVarTempMutPred = round(tm_me[[1]][,2]/sum(tm_me[[1]][,2]), 2),
        PropVarTempPhenPred = round(tm_pp[[1]][,2]/sum(tm_pp[[1]][,2]), 2),
        PropVarEnv2MutPred = round(sm_me[[1]][,2]/sum(sm_me[[1]][,2]), 2),
        PropVarEnv2PhenPred = round(sm_pp[[1]][,2]/sum(sm_pp[[1]][,2]), 2))
  # note the the 1st row is specific for each trait, I just took a shortcut for labeling the rowname
 rownames(z) <- rownames(tm_me[[1]])

 z
```

The models clarify how the architecture determines the proportion of clines - architecture also largely determines how accurate the mutation prediction is - yet the RDA phenotype prediction is not sensitive to the architecture and it is driven more by how correlated the phenotype is with the environment.


## Interesting sims to look at

This code just copies some of the figures into a new folder that I can download from the cluster.

```{r, eval=FALSE}
summary(final.df$RDA_RDAmutpred_cor_tempEffect)
summary(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr)
summary(final.df$RDA_RDAmutpred_cor_salEffect)
summary(final.df$RDA_RDAmutpred_cor_salEffect_structcorr)

# What is the difference between with and without structure?
par(mfrow=c(1,1))
hist(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect, xlim=c(-1,1))

hist(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect, xlim=c(-1,1))

# The seed with the most improvement from structcorr for temp
  i1 <- which(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect == max(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect))
  
  paste(final.df$level[i1], final.df$seed[i1])

# The seed with the least improvement from structcorr for temp
  i2 <- which(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect == min(final.df$RDA_RDAmutpred_cor_tempEffect_structcorr - final.df$RDA_RDAmutpred_cor_tempEffect))
  
  paste(final.df$level[i2],final.df$seed[i2])
  
# The seed with the most improvement from structcorr for sal
  i3 <- which(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect == max(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect, na.rm=TRUE))
  
  paste(final.df$level[i3],final.df$seed[i3])
  
# The seed with the least improvement from structcorr for sal
    i4 <- which(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect == min(final.df$RDA_RDAmutpred_cor_salEffect_structcorr - final.df$RDA_RDAmutpred_cor_salEffect, na.rm=TRUE))
  
    paste(final.df$level[i4],final.df$seed[i4])

# Seeds from Estuary sim, mod poly with high performance
  levels(final.df$demog_level)
   levels(final.df$arch_level)
   unique(final.df$ispleiotropy)
   unique(final.df$arch_level_sub)

  i5 <- final.df %>% 
    filter(demog_level=="Est-Clines", arch_level== "mod.\npolygenic", ispleiotropy==1, arch_level_sub== "2 traits\npleiotropy\nequal S") %>% 
    arrange(desc(RDA_cor_RDA20000temppredict_tempPhen), desc(RDA_cor_RDA20000salpredict_salPhen)) %>%
    head(4) %>% 
    select(level,seed,RDA_RDAmutpred_cor_salEffect, RDA_RDAmutpred_cor_tempEffect,
           RDA_cor_RDA20000salpredict_salPhen, RDA_cor_RDA20000temppredict_tempPhen)
  i5  

  # Seeds from mod poly with LOW performance
  i6 <- final.df %>% 
    filter(arch_level== "mod.\npolygenic",) %>% 
    arrange((RDA_cor_RDA20000temppredict_tempPhen), (RDA_cor_RDA20000salpredict_salPhen)) %>%
    head(2) %>% 
    select(level,seed,RDA_RDAmutpred_cor_salEffect, RDA_RDAmutpred_cor_tempEffect,
           RDA_cor_RDA20000salpredict_salPhen, RDA_cor_RDA20000temppredict_tempPhen)
  
  i6
  
  # Seed for improvement in Env2 trait prediction but worse temp trait prediction after structure correction
  
  i7 <- final.df %>% 
    filter(arch_level== "mod.\npolygenic",) %>% 
    arrange(desc(RDA_cor_RDA20000salpredict_salPhen_structcorr-RDA_cor_RDA20000salpredict_salPhen),(RDA_cor_RDA20000temppredict_tempPhen_structcorr-RDA_cor_RDA20000temppredict_tempPhen) ) %>%
    head(2) %>% 
    select(level,seed,RDA_RDAmutpred_cor_salEffect, RDA_RDAmutpred_cor_tempEffect,
           RDA_cor_RDA20000salpredict_salPhen, RDA_cor_RDA20000salpredict_salPhen_structcorr, 
           RDA_cor_RDA20000temppredict_tempPhen, RDA_cor_RDA20000temppredict_tempPhen_structcorr)
  i7
  
  (All_example_seeds <- sort(c(final.df$seed[i1], final.df$seed[i2], final.df$seed[i3],
                         final.df$seed[i4], i5$seed, i6$seed, i7$seed)))
  
  for (i in All_example_seeds){ #unhash to run
    file <- paste0("cp sim_output_20220428/",i,"*.pdf examples_20220428/")
    system(file)
  }
  
```


# RDA predictions as a function of the number of loci and structure correction
```{r}
rdapred <- read.table("summary_20220428_RDApredictions.txt", header=TRUE)
head(rdapred)

rdapred_df <- merge(rdapred, final.df, by="seed", all.x=TRUE)
head(rdapred_df)
rdapred_df$SIGMA_K_2 <- as.factor(as.character(rdapred_df$SIGMA_K_2))

rdapred_df1 <-  filter(rdapred_df, nloci %in% c(10,50,500,5000,20000))

r1<- ggplot(rdapred_df1 ) +
  geom_line( aes(x=nloci, y=Random_cor_RDAtemppredict_tempphen, group=seed, color=SIGMA_K_2), alpha=0.1, linetype="dashed") + facet_wrap(~arch_level) + ggtheme + ylim(-1,1) + ylab("Accuracy of RDA prediction\nTemperature trait\n worse <<--->> better")  + theme(legend.position = "none") + ggtitle("A) Temperature trait")  + stat_summary(aes(x=nloci, y=Random_cor_RDAtemppredict_tempphen, color=SIGMA_K_2),  size=2,geom="line", fun="mean")  + xlab("Number of random loci from genome") + theme(axis.text.x = element_text(angle = 60, vjust=1, hjust=1))
r1

r2 <- ggplot(rdapred_df1) + 
  geom_line(aes(x=nloci, y=Random_cor_RDAtemppredict_tempphen_structcorr, group=seed, color=SIGMA_K_2), alpha=0.1, linetype="dashed") + facet_wrap(~arch_level) + ggtheme + ylim(-1,1)+ ylab("Accuracy of structure-\ncorrected RDA prediction\nTemperature trait\n worse <<--->> better") + ggtitle("B) Temperature trait with structure correction")+ guides(color=guide_legend(title="Strength of\nstabilizing\nselection"))   + xlab("Number of random loci from genome") + theme(axis.text.x = element_text(angle = 60, vjust=1, hjust=1)) + stat_summary(aes(x=nloci, y=Random_cor_RDAtemppredict_tempphen_structcorr, color=SIGMA_K_2),  size=2,geom="line", fun="mean")  + xlab("Number of random loci from genome") + scale_color_hue(labels=c(expression(paste("Strong ", sigma[K]," = 0.5")), 
  expression(paste("Weak ", sigma[K]," = 4.0"))))
r2



r3 <- ggplot(rdapred_df1) + 
  geom_line(aes(x=nloci, y=Random_cor_RDAsalpredict_salphen, group=seed, color=as.factor(demog_level)), alpha=0.1,  linetype="dashed") + facet_wrap(~arch_level) + ggtheme + ylim(-1,1) + ylab("Accuracy of RDA prediction\nEnv2 trait\n worse <<--->> better")  + theme(legend.position = "none") + ggtitle("C) Env2 trait") + stat_summary(aes(x=nloci, y=Random_cor_RDAsalpredict_salphen, color=as.factor(demog_level)),  size=2,geom="line", fun="mean")  + xlab("Number of random loci from genome") + theme(axis.text.x = element_text(angle = 60, vjust=1, hjust=1))
r3
  
r4 <- ggplot(rdapred_df1) + 
  geom_line(aes(x=nloci, y=Random_cor_RDAsalpredict_salphen_structcorr, group=seed, color=as.factor(demog_level)), alpha=0.1, linetype="dashed") + facet_wrap(~arch_level) + ggtheme + ylim(-1,1) + ylab("Accuracy of structure-\ncorrected RDA prediction\nEnv2 trait\n worse <<--->> better") + ggtitle("D) Env2 trait with structure correction")  + guides(color=guide_legend(title="Landscape")) + stat_summary(aes(x=nloci, y=Random_cor_RDAsalpredict_salphen_structcorr, color=as.factor(demog_level)),  size=2,geom="line", fun="mean") + xlab("Number of random loci from genome") + theme(axis.text.x = element_text(angle = 60, vjust=1, hjust=1))
r4

pdf(paste0(outputs,"RDApredictionFunctionOfnLoci.pdf"), width=12, height=8)  
grid.arrange(r1,r2, r3, r4, nrow=2, layout_matrix=matrix(c(1,1,1,1,2,2,2,2,2
                                                           ,3,3,3,3,4,4,4,4,4),
                                                         nrow=2, byrow=TRUE)
             )
dev.off()
# removed rows expected based on single-trait simulations



```


Accuracy of RDA trait prediction as a function of the number of QTN loci in the simulation and strength of selection on the trait. The strength of selection on the trait also determines the strength of selection on the QTN loci in the architecture, how strongly they respond to selection, and the amount of LD around them when they sweep to high frequency in a deme or set of demes.

```{r}
head(rdapred_df1[,40:50])
final.df$SIGMA_K_2 <- as.factor(final.df$SIGMA_K_2)
levels(final.df$demog_level_sub)

# Remove the demography that had the worse performance in Env2
# so as not to bias the loess smoother

final.df1 <- final.df %>% filter(demog_level_sub != "N variable\nm variable")

rr1 <- ggplot(final.df1) + geom_point(aes(x=num_causal_postfilter, y=RDA_cor_RDA20000temppredict_tempPhen, color=SIGMA_K_2), alpha=0.4) + 
  geom_smooth(aes(x=num_causal_postfilter, y=RDA_cor_RDA20000temppredict_tempPhen, color=SIGMA_K_2), method="loess", span=10) + scale_x_log10() + ylim(0,1) + ggtheme + ylab("Accuracy of RDA prediction\nTemperature trait\nworse <<--->> better") + guides(color=guide_legend(title="Strength of\nstabilizing\nselection")) + xlab("Number of evolved QTN loci") + ggtitle("A) Accuracy for Temp. trait") + scale_color_hue(labels=c(expression(paste("Strong ", sigma[K]," = 0.5")), 
  expression(paste("Weak ", sigma[K]," = 4.0"))))
rr1

rr2 <- ggplot(final.df1) + geom_point(aes(x=num_causal_postfilter, y=RDA_cor_RDA20000salpredict_salPhen, color=demog_level), alpha=0.4) + 
  geom_smooth(aes(x=num_causal_postfilter, y=RDA_cor_RDA20000salpredict_salPhen, color=demog_level), method="loess", span=20) + scale_x_log10() + ylim(0,1) + ggtheme + ylab("Accuracy of RDA prediction\nEnv2 trait\nworse <<--->> better") + guides(color=guide_legend(title="Landscape")) + xlab("Number of evolved QTN loci") + ggtitle("B) Accuracy for Env2 trait (always strong selection)") #missing values expected for Env2 trait because not under selection in all sims
rr2

pdf(paste0(outputs,"RDAtraitpred_vs_nQTN.pdf"), width=10, height=5)
grid.arrange(rr1, rr2, nrow=1)
dev.off()
```






